---
title: "Section 2.3 TB treatment: coverage & outcomes"
author: "Takuya Yamanaka"
date: "`r Sys.Date()`"
knit: (function(inputFile, encoding) {
      out_dir <- "./local";
      rmarkdown::render(inputFile,
                        encoding=encoding,
                        output_dir=file.path(dirname(inputFile), out_dir))})
output: 
  html_fragment:
    # Do not include a table of contents
    toc: no
    # Set standard figure width to 12 inches
    fig_width: 12
    # Do not write figure captions
    fig_caption: FALSE
    # Don't embed external resources (stylesheets, JS libraries) in the output 
    self_contained: False    
    # Don't include <div> tags around a header and the content found until the next header
    section_divs: FALSE  

---


```{r setup, include=FALSE}
# Set chunk options.
# Results "asis" is useful to output markdown from a function
# Suppress messages, warnings and also the ## at the beginning of printed text

knitr::opts_chunk$set(echo = FALSE, 
                      results = "asis",
                      message = FALSE,
                      warning = FALSE,
                      error = TRUE, # for debugging!
                      
                      # Settings for better output of whomapper .png maps
                      fig.width = 10,
                      fig.height = 5,
                      dpi = 350
                      )

# Load output packages ----
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
library(ggplot2)
library(dplyr)
library(scales)
library(RColorBrewer)
# devtools::install_github("yamanakatakuya/whomapR")
# from https://github.com/yamanakatakuya/whomapR
library(whomapR)
library(gtbreport)
library(kableExtra)
library(here)
library(cowplot)
library(readr)

# Load R functions ----
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
source(here("report/functions/html_links.R"))
source(here("report/functions/output_ggplot.R"))

# Get the data sets and computed values/statistics for section 2.1 ----
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - 
source(here('report/ch2-3_prepare_data.r'))

# Load standard note about Indonesia moving to WPR ----
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
source(here("report/resources/IDN_2_WPR_note.R"))

# Show static chart in addition to Kendo chart?
show_static = F

# Save underlying data files as CSV and charts as PDF files?
pdf_csv_folder = here::here("report/local/figures/ch2.3")
save_csv = TRUE
save_pdf = TRUE
save_hidef = FALSE # TRUE only for producing a high definition map for the PDF!

# Create the output folder (only if it doesn't yet exist)
dir.create(pdf_csv_folder, showWarnings = FALSE, recursive = TRUE)

```


```{r css_js}
# Add standard stylesheets and javascript to support kendo
cat(writeLines(readLines(here("report/resources/headers.htm"))))
```

```{css, echo=FALSE}

/* Deaths averted table */
/* Recreating simple striped bootstrap table */
#deaths_averted_table {
  border-spacing: 0;
  border-collapse: collapse;
  margin-top: 1em;
  margin-bottom: 1em;
  /* Next two lines to allow horizontal scrolling on narrow screens */
  display: block;
  overflow-x: auto;
}

#deaths_averted_table th {
  border-bottom: 2px solid #DDDDDD;
  padding: 8px;
}

#deaths_averted_table td {
  border-top: 1px solid #DDDDDD;
  padding: 8px;
}

/* light gray for odd rows */
#deaths_averted_table tr:nth-child(odd) td {
  background-color: #F5F5F5;	
}

/* Bold for the final row with thick line above */
#deaths_averted_table tr:last-child td {
  border-top: 2px solid #DDDDDD;
  font-weight:bold;	
}

/* light gray when hovering over a row */
#deaths_averted_table tr:hover td {
  background-color: #DDDDDD;
}

/* Centre-align all column headings except for the first */
#deaths_averted_table th:not(:first-child) {
  text-align: center !important;
}

/* prevent numbers from wrapping in any of the columns */
#deaths_averted_table td {
  white-space: nowrap;
}


```


# 2.3 TB treatment: coverage and outcomes    

<span class="red">**Draft! Prepared `r Sys.Date()` using country-reported data snapshot files from `r format(as.Date(snapshot_date), format="%d %B %Y")`!**</span>

To minimize the ill health and mortality caused by tuberculosis (TB), everyone who develops TB disease needs to be able to promptly access diagnosis and treatment.

At the second United Nations (UN) high-level meeting on TB in 2023, Member States adopted a target that, by 2027, at least 90% of the estimated number of people who develop TB disease should be provided with quality-assured diagnosis and treatment (`r ref_lnk("1")`).

There are still large gaps between the estimated number of people who develop TB each year (incident cases; see <span class="red">Section 1.1</span> for further details) and the number of people newly diagnosed with TB and officially reported as a TB case (`r lnk("Fig. 2.3.1")`). This reflects a mixture of (i) underdiagnosis and (ii) underreporting of people diagnosed with TB to national authorities. 

Globally in `r report_year - 1`, the number of people who were newly diagnosed with TB and officially notified as a TB case (`r ftb(f2.3.1_txt2$c_newinc/1e6)` million) was `r ftb(f2.3.1_txt2$c_newinc/f2.3.1_txt2$e_inc_num *100)`% (95% uncertainty interval [UI]: `r ftb(f2.3.1_txt2$c_newinc/f2.3.1_txt2$e_inc_num_hi *100)`&#8211;`r ftb(f2.3.1_txt2$c_newinc/f2.3.1_txt2$e_inc_num_lo *100)`%) of the estimated number of incident cases. The gap, at `r ftb(f2.3.1_txt2$gap/1e6)` million, was lower than in `r report_year - 2` (`r ftb(f2.3.1_txt3$gap/1e6)` million) and has narrowed since 2020, a year in which it widened substantially (to a best estimate of `r ftb(f2.3.1_past |> filter(year==2020) |> select(gap)/1e6)` million) amid COVID-related disruptions in the first year of the pandemic.


### `r anch("Fig. 2.3.1")`<span class="red">Fig. 2.3.1</span> Number of people newly diagnosed with TB and officially notified as a TB case (new and recurrent cases,^a^ all forms) (black) compared with the estimated number of people who developed TB (incident cases) <span style="color:`r gtbreport::palette_gtb("inc")`">(green)</span>, 2010&#8211;`r report_year - 1`, globally and for WHO regions  
<div class="subhead">The shaded area represents the 95% uncertainty interval. `r IDN_2_WPR_note`</div>

```{r fig_2.3.1, fig.alt="Panel plot of incidence estimates compared to notifications by WHO region and globally since 2000",fig.height=6,  eval=show_estimates}

f2.3.1a_plot <- f2.3.1_data |> 
  
  filter(entity=="Global") |>
  
  ggplot(aes(x=year, y=c_newinc, ymin=0)) +
  
  geom_line(size=1) +
  
  geom_ribbon(aes(x=year, 
                  ymin=e_inc_num_lo, 
                  ymax=e_inc_num_hi),
              fill=gtbreport::palette_gtb("inc"),
              alpha=0.4) +
  
  geom_line(aes(year, e_inc_num),
            size=1,
            colour=gtbreport::palette_gtb("inc")) +

  facet_wrap( ~ entity, ncol = 4, scales="free_y") +
  
  scale_x_continuous(name="Year",
                     breaks = c(2010, 2015, 2015, 2020, report_year-1)) +

  # display y-axis scale in millions
  scale_y_continuous(name = "Millions per year", 
                     # Use the remainder operator in the labeller function to make sure we don't get weird effects
                     # when plotting small numbers
                     labels = function(i){ifelse((i/1e6) %% 1 == 0, round(i/1e6), round(i/1e6, 1))}) +

  theme_gtb()  +
  
  # Get rid of annoying x-axis line and ticks
  theme(axis.line.x = ggplot2::element_blank(),
        axis.ticks.x = element_blank())
  
f2.3.1b_plot <- f2.3.1_data |> 
    
  filter(entity!="Global") |>

  ggplot(aes(x=year, y=c_newinc, ymin=0)) +
  
  geom_line(size=1) +
  
  geom_ribbon(aes(x=year, 
                  ymin=e_inc_num_lo, 
                  ymax=e_inc_num_hi),
              fill=gtbreport::palette_gtb("inc"),
              alpha=0.4) +
  
  geom_line(aes(year, e_inc_num),
            size=1,
            colour=gtbreport::palette_gtb("inc")) +

  facet_wrap( ~ entity, ncol = 3, scales="free_y") +
  
  scale_x_continuous(name="Year",
                     breaks = c(2010, 2015, 2015, 2020, report_year-1)) +

  # display y-axis scale in millions
  scale_y_continuous(name = "Millions per year", 
                     # Use the remainder operator in the labeller function to make sure we don't get weird effects
                     # when plotting small numbers
                     labels = function(i){ifelse((i/1e6) %% 1 == 0, round(i/1e6), round(i/1e6, 1))}) +

  theme_gtb()  +
  
  # Get rid of annoying x-axis line and ticks
  theme(axis.line.x = ggplot2::element_blank(),
        axis.ticks.x = element_blank())
  
output_ggplot(f2.3.1a_plot, f2.3.1_data, show_static, pdf_csv_folder, save_csv, save_pdf)
output_ggplot(f2.3.1b_plot, f2.3.1_data, show_static, pdf_csv_folder, save_csv, save_pdf)


```
<div id="fig_2_3_1_global"></div>

<div class="row">
<div class="col-md-4">
<div id="fig_2_3_1_afro"></div>
</div>
<div class="col-md-4">
<div id="fig_2_3_1_amro"></div>
</div>
<div class="col-md-4">
<div id="fig_2_3_1_searo"></div>
</div>
</div>

<div class="row">
<div class="col-md-4">
<div id="fig_2_3_1_euro"></div>
</div>
<div class="col-md-4">
<div id="fig_2_3_1_emro"></div>
</div>
<div class="col-md-4">
<div id="fig_2_3_1_wpro"></div>
</div>
</div>

<div class="footnote">^a^ The term "relapse" was replaced with "recurrent" in WHO guidance on TB surveillance published in 2024 (`r ref_lnk("2")`).</div>

<hr />
<br />


Gaps between estimated incidence and the number of people newly diagnosed with TB and officially notified as a TB case have also been narrowing in most WHO regions (`r lnk("Fig. 2.3.1")`) and high TB burden countries (`r lnk("Fig. 2.3.2")`). The main exception is the Region of the Americas.


### `r anch("Fig. 2.3.2")`<span class="red">Fig. 2.3.2</span> Number of people newly diagnosed with TB and officially notified as a TB case (new and recurrent cases,^a^ all forms) (black) compared with the estimated number of people who developed TB (incident cases) <span style="color:`r gtbreport::palette_gtb("inc")`">(green)</span>, 30 high TB burden countries,^b^ 2010&#8211;`r report_year - 1` 
<div class="subhead">The shaded area represents the 95% uncertainty interval.</div> 

```{r fig_2.3.2, fig.alt="Forest plot of TB treatment coverage in 30 countries, regionally and globally", fig.asp=1.3, eval=show_estimates}

f2.3.2_plot <- f2.3.2_data |> 
  
  ggplot(aes(x=year, y=c_newinc, ymin=0)) +
  
  geom_line(size=1) +
  
  geom_ribbon(aes(x=year, 
                  ymin=e_inc_num_lo, 
                  ymax=e_inc_num_hi),
              fill=gtbreport::palette_gtb("inc"),
              alpha=0.4) +
  
  geom_line(aes(year, e_inc_num),
            size=1,
            colour=gtbreport::palette_gtb("inc")) +

  facet_wrap( ~ country, ncol = 3, scales="free_y") +
  
  scale_x_continuous(name="Year",
                     breaks = c(2010, 2015, 2015, 2020, report_year-1)) +

  # display y-axis scale in millions
  ylab("Number per year") + 
  scale_y_continuous(labels = function(x) format(x, big.mark = " ",
                                                             scientific = FALSE),
                                 limits = function(x){c(0, max(0.1, x))}) +

  theme_gtb()  +
  
  # Get rid of annoying x-axis line and ticks
  theme(axis.line.x = ggplot2::element_blank(),
        axis.ticks.x = element_blank())
  
output_ggplot(f2.3.2_plot, f2.3.2_data, show_static, pdf_csv_folder, save_csv, save_pdf)

```
<div class="row">
<div class="col-md-4">
<div id="fig_2_3_2_AGO"></div>
</div>
<div class="col-md-4">
<div id="fig_2_3_2_BGD"></div>
</div>
<div class="col-md-4">
<div id="fig_2_3_2_BRA"></div>
</div>
</div>

<div class="row">
<div class="col-md-4">
<div id="fig_2_3_2_CAF"></div>
</div>
<div class="col-md-4">
<div id="fig_2_3_2_CHN"></div>
</div>
<div class="col-md-4">
<div id="fig_2_3_2_COG"></div>
</div>
</div>

<div class="row">
<div class="col-md-4">
<div id="fig_2_3_2_PRK"></div>
</div>
<div class="col-md-4">
<div id="fig_2_3_2_COD"></div>
</div>
<div class="col-md-4">
<div id="fig_2_3_2_ETH"></div>
</div>
</div>

<div class="row">
<div class="col-md-4">
<div id="fig_2_3_2_GAB"></div>
</div>
<div class="col-md-4">
<div id="fig_2_3_2_IND"></div>
</div>
<div class="col-md-4">
<div id="fig_2_3_2_IDN"></div>
</div>
</div>

<div class="row">
<div class="col-md-4">
<div id="fig_2_3_2_KEN"></div>
</div>
<div class="col-md-4">
<div id="fig_2_3_2_LSO"></div>
</div>
<div class="col-md-4">
<div id="fig_2_3_2_LBR"></div>
</div>
</div>

<div class="row">
<div class="col-md-4">
<div id="fig_2_3_2_MNG"></div>
</div>
<div class="col-md-4">
<div id="fig_2_3_2_MOZ"></div>
</div>
<div class="col-md-4">
<div id="fig_2_3_2_MMR"></div>
</div>
</div>

<div class="row">
<div class="col-md-4">
<div id="fig_2_3_2_NAM"></div>
</div>
<div class="col-md-4">
<div id="fig_2_3_2_NGA"></div>
</div>
<div class="col-md-4">
<div id="fig_2_3_2_PAK"></div>
</div>
</div>

<div class="row">
<div class="col-md-4">
<div id="fig_2_3_2_PNG"></div>
</div>
<div class="col-md-4">
<div id="fig_2_3_2_PHL"></div>
</div>
<div class="col-md-4">
<div id="fig_2_3_2_SLE"></div>
</div>
</div>

<div class="row">
<div class="col-md-4">
<div id="fig_2_3_2_ZAF"></div>
</div>
<div class="col-md-4">
<div id="fig_2_3_2_THA"></div>
</div>
<div class="col-md-4">
<div id="fig_2_3_2_UGA"></div>
</div>
</div>

<div class="row">
<div class="col-md-4">
<div id="fig_2_3_2_TZA"></div>
</div>
<div class="col-md-4">
<div id="fig_2_3_2_VNM"></div>
</div>
<div class="col-md-4">
<div id="fig_2_3_2_ZMB"></div>
</div>
</div>

<div class="footnote">^a^ The term "relapse" was replaced with "recurrent" in WHO guidance on TB surveillance published in 2024 (`r ref_lnk("2")`).
<br>^b^ Incidence estimates are not shown for the Democratic Peopleâ€™s Republic of Korea, since they are currently under review.</div>

<br />

In comparing estimates of TB incidence with case notification data, it is important to highlight that notification data may be artificially inflated by overdiagnosis of TB, particularly among people diagnosed without bacteriological confirmation of disease. For example, the proportion of notified cases diagnosed based on bacteriological confirmation in `r report_year-1` was less than 50% in Papua New Guinea (45%) and the Philippines (46%) (<span class="red">Fig. 2.2.8 of Section 2.2</span>). People correctly diagnosed with TB may also be missing from notification data, due to underreporting. In some countries, estimates of TB incidence would benefit from new studies (such as a national TB prevalence survey or national TB inventory study) to directly measure the underlying burden of TB disease in the population. For example, the main data sources used to inform the current estimates of TB incidence in Uganda and Zambia, countries in which notifications came very close to estimated levels of incidence in 2022 and 2022&#8211;2023 respectively, are national TB prevalence surveys that were implemented in 2014&#8211;2015 (Uganda) and 2013&#8211;2014 (Zambia) (<span class="red">Section 1.4</span>). 

<hr />
<br />

In `r report_year-1`, ten countries accounted for `r ftb(f2.3.3_txt2$pct_gap_top_ten)`% of the global gap between the estimated number of people who developed TB (incident TB cases) and the number of people who were diagnosed with TB and officially reported as a TB case (`r lnk("Fig. 2.3.3")`). About 40% of the global gap was accounted for by five countries: `r f2.3.3_txt |> slice(1) |> select(country)` (`r ftb(f2.3.3_txt |> slice(1) |> select(pct_gap))`%), `r f2.3.3_txt |> slice(2) |> select(country)` (`r ftb(f2.3.3_txt |> slice(2) |> select(pct_gap))`%), the `r f2.3.3_txt |> slice(3) |> select(country)` (`r ftb(f2.3.3_txt |> slice(3) |> select(pct_gap))`%), `r f2.3.3_txt |> slice(4) |> select(country)` (`r ftb(f2.3.3_txt |> slice(4) |> select(pct_gap))`%) and `r f2.3.3_txt |> slice(5) |> select(country)` (`r ftb(f2.3.3_txt |> slice(5) |> select(pct_gap))`%).

### `r anch("Fig. 2.3.3")`<span class="red">Fig. 2.3.3</span> The ten countries with the largest gaps between notifications of people newly diagnosed with TB and the best estimates of TB incidence, `r report_year-1`^a^

```{r fig_2.3.3, fig.alt="Bubble map of difference between notifications and estimated incidence for 10 countries", eval=show_estimates}

if (save_hidef == TRUE) {
  # Generate a high definition map for the PDF
  # Update fig numbering according to the masterlist of figs/tables
  f21_data <- f2.3.3_data 
  
  f21_plot <- f21_data |>
  
  arrange(iso3) |>
  
  bubblemapper(legend_title = "",
               legend_pos = "none",
               bubble_col = "purple",
               scale_breaks = NULL,
               scale_limits = NULL,
               scale_labels = NULL,
               hidef = save_hidef)
  
output_ggplot(f21_plot, f21_data, show_static, pdf_csv_folder, save_csv, save_pdf)
  
  
} else {
  # Generate a standard map for the web page
  
  f2.3.3_plot <- f2.3.3_data |>
  
  arrange(iso3) |>
  
  bubblemapper(legend_title = "Size of gap",
               legend_pos = c(0.14, 0.5),
               bubble_col = "purple",
               scale_breaks = c(5e4, 1.5e5, 2.5e5),
               scale_limits = c(5e4, 2.5e5),
               scale_labels = c("50 000","150 000","250 000")) +
  
  add_annotate('text', label='China', x=151, y=36, size=2.5, include_coord = TRUE) +
  add_annotate('segment',x=98, xend=145, y=36, yend=36, linewidth = 0.2) +
  
  add_annotate(geom='text', label='Viet Nam', x=151, y=25, size=2.5) +
  add_annotate('segment', x=108, xend=142, y=16, yend=25, linewidth = 0.2) +
  
  add_annotate(geom='text', label='Philippines', x=152, y=17, size=2.5) +
  add_annotate('segment', x=125, xend=142, y=8, yend=17, linewidth = 0.2) +

  add_annotate(geom='text', label='Indonesia', x=107, y=-16, size=2.5) +
  add_annotate('segment', x=113, xend=105, y=0, yend=-14, linewidth = 0.2) +

  add_annotate(geom='text', label='Myanmar', x=90, y=-11, size=2.5) +
  add_annotate('segment', x=96, xend=88, y=19, yend=-8, linewidth = 0.2) +

  add_annotate(geom='text', label='Bangladesh', x=152, y=31, size=2.5) +
  add_annotate('segment', x=91, xend=140, y=24, yend=31, linewidth = 0.2) +

  add_annotate(geom='text', label='India', x=78, y=-6, size=2.5) +
  add_annotate('segment', x=81, xend=78, y=22.5, yend=-3.5, linewidth = 0.2) +
  
  add_annotate(geom='text', label='Pakistan', x=68, y=-1, size=2.5) +
  add_annotate('segment', x=70, xend=67, y=30.5, yend=1, linewidth = 0.2) +
  
  add_annotate(geom='text', label='Nigeria', x=-11, y=0, size=2.5) +
  add_annotate('segment', x=8, xend=-4, y=9, yend=0, linewidth = 0.2) +
  
  add_annotate(geom='text', label='Democratic\nRepublic\nof the Congo', x=-10, y=-20, size=2.5) +
  add_annotate('segment', x=23, xend=0, y=-4, yend=-20, linewidth = 0.2)  #+
  
  # annotate(geom='text', label='South Africa', x=50, y=-30, hjust=0, size=3) +
  # geom_segment(x=25, xend=45, y=-30, yend=-30)
  

output_ggplot(f2.3.3_plot, f2.3.3_data, show_static = T, pdf_csv_folder, save_csv, save_pdf)

}

```
<div class="footnote">^a^ The ten countries ranked in order of the size of the gap between notified cases and the best estimates of TB incidence in `r report_year-1` are `r if(show_estimates){gsub("Viet Nam", "Viet&nbsp;Nam", gsub("(Democrat)|(Philip)", "the \\1\\2", knitr::combine_words(f2.3.3_data$country, oxford_comma=FALSE)))}`.</div>

<hr />
<br />

Among people living with HIV who develop TB, both TB treatment and antiretroviral treatment (ART) for HIV are necessary to prevent unnecessary deaths from TB and HIV. Since 2019, the global coverage of ART for people newly diagnosed and reported with TB and known to be living with HIV has been maintained at a high level;  in `r report_year-1` it reached `r ftb(f2.3.4_txt$c_art_notified_2024)`%, up from `r ftb(f2.3.4_txt$c_art_notified_2023)`% in `r report_year-2` (the <span style="color:#277abe;">blue</span> curve compared with the black curve) (`r lnk("Fig. 2.3.4")`). 

However, when compared with the total number of people living with HIV who are estimated to have developed TB in `r report_year-1` (the <span style="color:`r gtbreport::palette_gtb("inch")`;">red</span> curve), coverage was much lower, at `r ftb(f2.3.4_txt$c_art_estimated_2024)`%, almost unchanged from `r ftb(f2.3.4_txt$c_art_estimated_2023)`% in `r report_year-2`. Among WHO regions, the highest levels of ART coverage among people living with HIV who developed TB in `r report_year-1` were achieved in the African Region (a best estimate of `r ftb(f2.3.5_txt3 |> slice(1) |> select(c_art))`%); coverage was lowest in the Eastern Mediterranean Region (a best estimate of `r ftb(f2.3.5_txt3 |> slice(2) |> select(c_art))`%). 


### `r anch("Fig. 2.3.4")`<span class="red">Fig. 2.3.4</span> Estimated number of incident cases of TB among people living with HIV<span style="color:`r gtbreport::palette_gtb("inch")`;"> (red)</span> compared with notifications of people newly diagnosed with TB who were known to be living with HIV (black) and the number of people living with HIV who were diagnosed with TB and started on antiretroviral therapy<span style="color:#277abe;"> (blue)</span>, globally and for WHO regions, 2010&#8211;`r report_year-1`  
<div class="subhead">The shaded area represents the 95% uncertainty interval. `r IDN_2_WPR_note`</div>

```{r fig_2.3.4, fig.alt="Line and ribbon chart of estimated TB/HIV incidence, number notified and number on antiretroviral therapy", eval=show_estimates}

f2.3.4_plot <- f2.3.4_data |> 

  ggplot(aes(x=year, y=hivpos, ymin=0)) +
  geom_line(size=1) +
  
  geom_ribbon(aes(x=year, ymin=e_inc_tbhiv_num_lo, ymax=e_inc_tbhiv_num_hi),
              fill=gtbreport::palette_gtb("inch"),
              alpha=0.4) +
  geom_line(aes(year, e_inc_tbhiv_num),
            size=1,
            colour=gtbreport::palette_gtb("inch")) +

  geom_line(aes(year, art),
            size=1,
            colour="#277abe") +

  scale_x_continuous(name="Year",
                     breaks = seq(2004, report_year-1, by = 3)) +

  scale_y_continuous(name = "New and recurrent cases per year (millions)",
                     labels = function(i){i/1e6}
                     ) +
  xlab("Year") +
  
  theme_gtb() +
  
  # Get rid of annoying x-axis line and ticks
  theme(axis.line.x = ggplot2::element_blank(),
        axis.ticks.x = element_blank())


## -- regional trend -- ##
f2.3.4b_plot <- f2.3.4_region_data |> 
  
  ggplot(aes(x=year, y=hivpos, ymin=0)) +
  geom_line(size=1) +
  
  geom_ribbon(aes(x=year, ymin=e_inc_tbhiv_num_lo, ymax=e_inc_tbhiv_num_hi),
              fill=gtbreport::palette_gtb("inch"),
              alpha=0.4) +
  geom_line(aes(year, e_inc_tbhiv_num),
            size=1,
            colour=gtbreport::palette_gtb("inch")) +

  geom_line(aes(year, art),
            size=1,
            colour="#277abe") +

  facet_wrap( ~ entity, ncol = 3, scales="free_y") +

  scale_x_continuous(name="Year",
                     breaks = seq(2004, report_year-1, by = 3)) +

  scale_y_continuous(name = "New and recurrent cases per year (thousands)",
                     labels = function(i){i/1e3}
                     ) +
  xlab("Year") +
  
  theme_gtb() +
  
  # Get rid of annoying x-axis line and ticks
  theme(axis.line.x = ggplot2::element_blank(),
        axis.ticks.x = element_blank())

output_ggplot(f2.3.4_plot, f2.3.4_data, show_static, pdf_csv_folder, save_csv, save_pdf)
output_ggplot(f2.3.4b_plot, f2.3.4_region_data, show_static, pdf_csv_folder, save_csv, save_pdf)

```
<div id="fig_2_3_4"></div>

<div class="row">
<div class="col-md-4">
<div id="fig_2_3_4_afro"></div>
</div>
<div class="col-md-4">
<div id="fig_2_3_4_amro"></div>
</div>
<div class="col-md-4">
<div id="fig_2_3_4_searo"></div>
</div>
</div>

<div class="row">
<div class="col-md-4">
<div id="fig_2_3_4_euro"></div>
</div>
<div class="col-md-4">
<div id="fig_2_3_4_emro"></div>
</div>
<div class="col-md-4">
<div id="fig_2_3_4_wpro"></div>
</div>
</div>


<hr />
<br />

All ART coverage estimates for people with TB are far below the overall coverage of ART for people living with HIV, which was 77% (95% UI: 62&#8211;90%) at the end of `r report_year-1` (`r ref_lnk("3")`). The main reason for relatively low ART coverage for people with TB is the persistently large gap between the estimated number of people living with HIV who developed TB each year and the number of people living with HIV who are reported to have been diagnosed with TB. 

At regional level, the biggest gaps in `r report_year-1` were in the Eastern Mediterranean and Western Pacific regions, where `r ftb(f2.3.4_region_txt |> filter(g_whoregion=="EMR") |> select(gap_hivpos_estimated_2024 ))`% and `r ftb(f2.3.4_region_txt |> filter(g_whoregion=="WPR") |> select(gap_hivpos_estimated_2024 ))`% respectively of the estimated number of people living with HIV who developed TB in `r report_year-1` were not diagnosed with TB and reported. 


Among the 30 high TB/HIV burden countries, best estimates of the coverage of ART among people living with HIV who developed TB in `r report_year-1` varied widely, from `r ftb(f2.3.5_txt$c_art_bottom)`% in `r f2.3.5_txt$entity_bottom` to `r ftb(f2.3.5_txt$c_art_top)`% in `r f2.3.5_txt$entity_top`; only `r f2.3.5_txt$over_50` of these 30 countries achieved coverage of at least 50% (`r lnk("Fig. 2.3.5")`).


### `r anch("Fig. 2.3.5")`<span class="red">Fig. 2.3.5</span> Estimated coverage of antiretroviral therapy for people living with HIV who developed TB^a^ in `r report_year-1`, 30 high TB/HIV burden countries, WHO regions and globally
<div class="subhead">`r IDN_2_WPR_note2`</div>

```{r fig_2.3.5, fig.alt="Forest plot of ART treatment coverage for TB/HIV patients in 30 countries, regionally and globally", fig.asp=1, eval=show_estimates}

f2.3.5_plot <- f2.3.5_data |> 

  ggplot(aes(x=entity,
             y=c_art)) +
  geom_point() +
  
  labs(x="",
       y="Treatment coverage (%)") +
  
  geom_pointrange(aes(ymin=c_art_lo,
                      ymax=c_art_hi),
                  size=1,
                  colour="#ed6476") +
  
  expand_limits(y=0) +
  coord_flip() +
  theme_gtb() 
  
output_ggplot(f2.3.5_plot, f2.3.5_data, show_static, pdf_csv_folder, save_csv, save_pdf)

```
<div id="fig_2_3_5"></div>
<div class="footnote">^a^ People living with HIV who were newly diagnosed with TB and on antiretroviral therapy, as a percentage of the estimated number of incident TB cases among people living with HIV.
<br />^b^ Data on the number of people living with HIV who were newly diagnosed with TB and on antiretroviral therapy were not reported by Liberia.</div>

<hr />
<br />

Globally, the treatment success rate for people treated for drug-susceptible TB with first-line regimens was `r ftb(f2.3.6_txt$tsr_Global)`% in `r report_year-2` (the latest year for which treatment outcome data are available), and ranged from `r ftb(f2.3.6_txt$tsr_AMR)`% in the WHO Region of the Americas to `r ftb(f2.3.6_txt$tsr_EMR)`% in the WHO Eastern Mediterranean Region (`r lnk("Fig. 2.3.6")`). 

### `r anch("Fig. 2.3.6")`<span class="red">Fig. 2.3.6</span> Treatment outcomes for people diagnosed with TB in `r report_year-2` (new and recurrent cases^a^) who were treated for drug-susceptible TB using first-line regimens, WHO regions and globally
<div class="subhead">`r IDN_2_WPR_note2`</div>

```{r fig_2.3.6, fig.alt="Horizontal bar chart showing TB treatment outcomes for WHO regions and globally"}

f2.3.6_plot <- f2.3.6_data |> 
  
  ggplot(aes(x=entity, 
             y=value, 
             fill = factor(outcome,
                           levels = c("Treatment success",
                                      "Treatment failed",
                                      "Died",
                                      "Lost to follow-up",
                                      "Not evaluated")))) +
 
  geom_col(position = position_stack(reverse = TRUE)) +
  coord_flip() +

  theme_gtb() +
  
  scale_fill_manual("", 
                    values = c("Treatment success" = palette_gtb("succ"),
                               "Treatment failed" = palette_gtb("fail"),
                               "Died" = palette_gtb("died"),
                               "Lost to follow-up" = palette_gtb("ltfu"),
                               "Not evaluated" = palette_gtb("neval"))) +
  
  labs(x="", y="Percentage of cohort") +

  geom_text(data=subset(f2.3.6_data, 
                        outcome=="Treatment success"),
            aes(label = round(value, digits = 0)),
            position = position_stack(reverse = TRUE), 
            size=3,
            hjust=1.5,
            color="white")

  

output_ggplot(f2.3.6_plot, f2.3.6_data, show_static, pdf_csv_folder, save_csv, save_pdf)

```
<div id="fig_2_3_6"></div>
<div class="footnote">^a^ The term "relapse" was replaced with "recurrent" in WHO guidance on TB surveillance published in 2024 (`r ref_lnk("2")`).</div>

<hr />
<br />

Globally, there were steady improvements in the treatment success rate between 2016 and `r report_year-2`: from `r ftb(f2.3.7_2016_txt$overall)`% in 2016 to `r ftb(f2.3.7_txt$overall)`% in `r report_year-2` (`r lnk("Fig. 2.3.7")`). The treatment success rate remains lower among people living with HIV, at `r ftb(f2.3.7_txt$hivpos)`% globally in `r report_year-2`, but this is up from `r ftb(f2.3.7_2017_txt$hivpos)`% in 2017 and far better than the level of `r ftb(f2.3.7_2012_txt$hivpos)`% in 2012.

### `r anch("Fig. 2.3.7")`<span class="red">Fig. 2.3.7</span> Treatment outcomes for people diagnosed with TB (new and recurrent cases^a^) who were treated for drug-susceptible TB using first-line regimens, 2012&#8211;`r report_year-2` 

```{r fig_2.3.7, fig.alt="Panel of 2 horizontal bar charts showing TB treatment outcomes globally by year since 2012 for TB and TB/HIV", fig.asp=0.6}

f2.3.7_plot <- f2.3.7_data |>
  
  ggplot(aes(year,
             value,
             fill = factor(outcome,
                           levels = c("Treatment success",
                                      "Treatment failed",
                                      "Died",
                                      "Lost to follow-up",
                                      "Not evaluated")))) +
 
  geom_col(position = position_stack(reverse = TRUE)) +

  facet_wrap( ~ subgroup, nrow = 2) +
  
  coord_flip() +

  theme_gtb() +

  scale_fill_manual("", 
                    values = c("Treatment success" = palette_gtb("succ"),
                               "Treatment failed" = palette_gtb("fail"),
                               "Died" = palette_gtb("died"),
                               "Lost to follow-up" = palette_gtb("ltfu"),
                               "Not evaluated" = palette_gtb("neval"))) +

  labs(x="Year started on treatment", y="Percentage of cohort") +

  scale_x_continuous(breaks = seq(2012, report_year-2)) +

  geom_text(data=subset(f2.3.7_data,
                        outcome=="Treatment success"),
            aes(label = round(value, digits = 0)),
			            position = position_stack(reverse = TRUE),
            size=3,
            hjust=1.5,
            color="white")



output_ggplot(f2.3.7_plot, f2.3.7_data, show_static, pdf_csv_folder, save_csv, save_pdf)

```
<div id="fig_2_3_7a"></div>
<div id="fig_2_3_7b"></div>

<div class="footnote">^a^ The term "relapse" was replaced with "recurrent" in WHO guidance on TB surveillance published in 2024 (`r ref_lnk("2")`).</div>

<hr />
<br />

Among WHO regions, the best treatment success rate among people living with HIV was achieved in the African Region, where the burden of HIV-associated TB is highest (`r lnk("Fig. 2.3.8")`).

### `r anch("Fig. 2.3.8")`<span class="red">Fig. 2.3.8</span> Treatment outcomes for people living with HIV who were diagnosed with TB (new and recurrent cases^a^) who were treated for drug-susceptible TB using first-line regimens, WHO regions and globally, `r report_year-2`
<div class="subhead">`r IDN_2_WPR_note2`</div>

```{r fig_2.3.8, fig.alt="Horizontal bar chart showing TB treatment outcomes in HIV-positive cases for WHO regions and globally"}

f2.3.8_plot <- f2.3.8_data |>

  # Note: plotting code same as 3.4.1 -- build a re-usable function?
  ggplot(aes(x=entity, 
             y=value, 
             fill = factor(outcome,
                           levels = c("Treatment success",
                                      "Treatment failed",
                                      "Died",
                                      "Lost to follow-up",
                                      "Not evaluated")))) +
 
  geom_col(position = position_stack(reverse = TRUE)) +
  coord_flip() +

  theme_gtb() +
  
  scale_fill_manual("", 
                    values = c("Treatment success" = palette_gtb("succ"),
                               "Treatment failed" = palette_gtb("fail"),
                               "Died" = palette_gtb("died"),
                               "Lost to follow-up" = palette_gtb("ltfu"),
                               "Not evaluated" = palette_gtb("neval"))) +
  
  labs(x="", y="Percentage of cohort") +

  geom_text(data=subset(f2.3.8_data, 
                        outcome=="Treatment success"),
            aes(label = round(value, digits = 0)),
            position = position_stack(reverse = TRUE), 
            size=3,
            hjust=1.5,
            color="white")


output_ggplot(f2.3.8_plot, f2.3.8_data, show_static, pdf_csv_folder, save_csv, save_pdf)

```
<div id="fig_2_3_8"></div>

<div class="footnote">^a^ The term "relapse" was replaced with "recurrent" in WHO guidance on TB surveillance published in 2024 (`r ref_lnk("2")`).</div>

<hr />
<br />

Among the 49 countries in one of the three global lists of high burden countries (for TB, HIV-associated TB and MDR/RR-TB) being used by WHO in the period 2021&#8211;2025 (see <span class="red">Annex 3</span> of the core report document), `r ftb(f2.3.9_txt3)` reported treatment outcome data disaggregated by sex. The treatment success rate in women and girls was `r ftb(f2.3.9_txt$value)`% in `r report_year-2`, slightly higher than that among men and boys (`r ftb(f2.3.9_txt2$value)`%) (`r lnk("Fig. 2.3.9")`).

### `r anch("Fig. 2.3.9")`<span class="red">Fig. 2.3.9</span> Treatment outcomes for people diagnosed with TB (new and recurrent cases^a^) who were treated for drug-susceptible TB using first-line regimens, disaggregated by sex for `r ftb(f2.3.9_txt3)` high burden countries that reported data,^b^ 2019&#8211;`r report_year-2` 

```{r fig_2.3.9, fig.alt="Panel of 2 horizontal bar charts showing TB treatment outcomes globally by year since 2019 by sex", fig.asp=0.4}

f2.3.9_plot <- f2.3.9_data |>
  
  ggplot(aes(year,
             value,
             fill = factor(outcome,
                           levels = c("Treatment success",
                                      "Treatment failed",
                                      "Died",
                                      "Lost to follow-up",
                                      "Not evaluated")))) +
 
  geom_col(position = position_stack(reverse = TRUE)) +

  facet_wrap( ~ subgroup, nrow = 2) +
  
  coord_flip() +

  theme_gtb() +

  scale_fill_manual("", 
                    values = c("Treatment success" = palette_gtb("succ"),
                               "Treatment failed" = palette_gtb("fail"),
                               "Died" = palette_gtb("died"),
                               "Lost to follow-up" = palette_gtb("ltfu"),
                               "Not evaluated" = palette_gtb("neval"))) +

  labs(x="Year started on treatment", y="Percentage of cohort") +

  scale_x_continuous(breaks = seq(2019, report_year-2)) +

  geom_text(data=subset(f2.3.9_data,
                        outcome=="Treatment success"),
            aes(label = round(value, digits = 0)),
			            position = position_stack(reverse = TRUE),
            size=3,
            hjust=1.5,
            color="white")



output_ggplot(f2.3.9_plot, f2.3.9_data, show_static, pdf_csv_folder, save_csv, save_pdf)

```
<div id="fig_2_3_9a"></div>
<div id="fig_2_3_9b"></div>
<div class="footnote">^a^ The term "relapse" was replaced with "recurrent" in WHO guidance on TB surveillance published in 2024 (`r ref_lnk("2")`).
<br>^b^ WHO has requested data on treatment outcomes disaggregated by sex from the 49 countries in one of the three lists of high burden countries (for TB, HIV-associated TB and MDR/RR-TB) since the 2021 round of global TB data collection. The countries from which such data are requested may be expanded in future (for example, to include all countries with case-based digital surveillance systems for TB).</div>

<hr />
<br />

The treatment success rate for people aged 0&#8211;14 years was `r ftb(f2.3.10_txt$tsr_014_Global)`% in `r report_year-2` (`r lnk("Fig. 2.3.10")`). Among the six WHO regions, the best treatment success rate among people aged 0&#8211;14 years was achieved in the African Region (`r ftb(f2.3.10_txt2$c_tsr_014)`%).

### `r anch("Fig. 2.3.10")`<span class="red">Fig. 2.3.10</span> Treatment success rates for people aged 0&#8211;14 years who were diagnosed with TB (new and recurrent cases^a^), WHO regions and globally^b^, `r report_year-2` 
<div class="subhead">`r IDN_2_WPR_note2`</div>

```{r fig_2.3.10, fig.alt="Horizontal bar chart showing TB treatment success rates in children for WHO regions and globally"}

f2.3.10_plot <- f2.3.10_data |>
  
  ggplot(aes(x = entity, y = c_tsr_014)) +

  geom_bar(stat = "identity", fill = palette_gtb("succ")) +

  coord_flip() +

  theme_gtb() +

  scale_y_continuous(name = "Percentage of cohort",
                     limits = c(0,100)) +

  labs(x="") +

  geom_text(aes(label = round(c_tsr_014, digits = 0)),
            position = position_stack(reverse = TRUE), 
            size=3,
            hjust=1.5,
            color="white")


output_ggplot(f2.3.10_plot, f2.3.10_data, show_static, pdf_csv_folder, save_csv, save_pdf)

```
<div id="fig_2_3_10"></div>

<div class="footnote">^a^ The term "relapse" was replaced with "recurrent" in WHO guidance on TB surveillance published in 2024 (`r ref_lnk("2")`).
<br>^b^ Data were reported by `r f2.3.10_txt$countries` countries on outcomes for `r int_spacer(f2.3.10_txt$kids_coh)` people aged 0&#8211;14 years, equivalent to `r ftb(f2.3.10_txt$kids_outcome_pct)`% of the `r int_spacer(f2.3.10_txt$kids_notified)` cases among people aged 0&#8211;14 years that were notified in `r report_year-2`.</div> 

<hr />
<br />

The provision of TB treatment, as well as the provision of ART to people living with HIV, has averted millions of deaths (`r lnk("Table 2.3.1")`).

### `r anch("Table 2.3.1")`<span class="red">Table 2.3.1</span> Cumulative number of deaths (in millions) averted by a) TB treatment as well as b) antiretroviral treatment for people diagnosed with TB who were also living with HIV, globally and by WHO region, `r lsaved_year`&#8211;`r report_year - 1`
<div class="subhead">`r IDN_2_WPR_note2`</div>

```{r table_2.3.1, eval= TRUE }

# Format numbers for the table
t2.3.1_data <- t2.3.1_data |>
  mutate(across(where(is.numeric), ftb))

# Create a table object using kable
table_header <- c('WHO region',
                  'Best estimate',
                  'Uncertainty interval',
                  'Best estimate',
                  'Uncertainty interval',
                  'Best estimate',
                  'Uncertainty interval')

knitr::kable(t2.3.1_data,
             format = "html",
             col.names = table_header,
             align = 'lccccc',
             # Add a table ID so that it can be styled using extra CSS in Sitefinity
             table.attr = "id='deaths_averted_table'") |>
  add_header_above(header = c(" " = 1,
                              "HIV-negative people" = 2,
                              "People living with HIV\U1D43" = 2,
                              "Total" = 2))


```
<div class="footnote">^a^ Deaths from TB among people with HIV are officially classified as deaths caused by HIV/AIDS (with TB as a contributory cause). This is the reason why the estimates make a clear distinction between people with and without HIV.</div> 

<br />
The combination of TB treatment and ART for people living with HIV is estimated to have averted `r ftb(t2.3.1_hiv_txt)` million deaths between 2005, the first year following the release of an interim WHO policy on collaborative TB/HIV activities in 2004 (`r ref_lnk("4")`), and `r report_year-1`. 

<hr />
<br />

The most widely-used drug regimen for treatment of drug-susceptible TB lasts 6 months. 
Since 2022, a shorter 4-month regimen consisting of isoniazid, rifapentine, moxifloxacin and pyrazinamide (HPMZ) has also been recommended by WHO for the treatment of rifampicin-susceptible TB (`r ref_lnk("5")`). For people aged between 3 months and 16 years with non-severe TB, a 4-month regimen composed of isoniazid, rifampicin, pyrazinamide and ethambutol (2HRZ(E)/2HR) has also been recommended since 2022 (`r ref_lnk("5")`,`r ref_lnk("6")`). To date, the 4-month regimens have not been widely used. 

Globally in `r report_year - 1`, `r f2.3.11_data_trend |> filter(year == report_year-1) |> select(nrr_hpmz_tx) |> unlist()` people diagnosed with TB were reported to have been started on treatment with the 4-month HPMZ regimen, up from `r f2.3.11_data_trend |> filter(year == report_year-2) |> select(nrr_hpmz_tx) |> unlist()` in `r report_year - 2`.
A total `r f2.3.11_hpmz_txt` countries and areas reported using the regimen by the end of `r report_year - 1`: `r knitr::combine_words(f2.3.11_txt_hpmz_list$country_in_text_EN, oxford_comma=FALSE)`. This was an increase from `r int2word(f2.3.11_data_trend |> filter(year == report_year-2) |> select(nrr_hpmz_used  ) |> unlist())` countries in `r report_year - 2`. 

Globally in `r report_year - 1`, a total of `r f2.3.11_data_trend |> filter(year == report_year-1) |> select(nrr_2hrze2hr_tx) |> unlist()` people were started on treatment with the 2HRZ(E)/2HR regimen, up from `r f2.3.11_data_trend |> filter(year == report_year-2) |> select(nrr_2hrze2hr_tx) |> unlist()` in `r report_year - 2`. A total of `r f2.3.11_2hrze2hr_txt` countries and areas reported using the regimen by the end of `r report_year - 1`: `r knitr::combine_words(f2.3.11_txt_2hrze2hr_list$country_in_text_EN, oxford_comma=FALSE)`, up from `r f2.3.11_data_trend |> filter(year == report_year-2) |> select(nrr_2hrze2hr_used) |> unlist()` countries and areas in `r report_year - 2` (`r lnk("Fig. 2.3.11")`).

### `r anch("Fig. 2.3.11")`<span class="red">Fig. 2.3.11</span> Countries that reported using 4-month regimens for treatment of rifampicin-susceptible TB by the end of  `r report_year-1`

```{r fig_2.3.11, fig.alt="World map showing countries using the new 4-month regimen"}

f2.3.11_plot <- f2.3.11_data |> 

  whomapper(colours = palatte_fig2.3.11,
         legend_title = "")

output_ggplot(f2.3.11_plot, f2.3.11_data, show_static = T, pdf_csv_folder, save_csv, save_pdf)

```

<hr />
<br />

Further country-specific details about the gap between TB incidence and notifications and treatment outcomes are available in the [Global tuberculosis report app](https://www.who.int/teams/global-tuberculosis-programme/data#app) and [country profiles](https://worldhealthorg.shinyapps.io/tb_profiles/).

Data shown on this webpage are as of `r format(as.Date(snapshot_date), format="%d %B %Y")` (see <span class="red">Annex 2</span> of the core report document for more details).

`r anch("refs")`

<hr style="border:1px solid gray20">

**References**

1. Political declaration of the high-level meeting of the General Assembly on the fight against tuberculosis. New York: United Nations; 2023 (https://www.un.org/pga/77/wp-content/uploads/sites/105/2023/09/TB-Final-Text.pdf).

2. Consolidated guidance on tuberculosis data generation and use: module 1: tuberculosis surveillance. Geneva: World Health Organization; 2024  (https://iris.who.int/handle/10665/376612). License: CC BY-NC-SA 3.0 IGO.

3. Global HIV & AIDS statistics &#8211; fact sheet [website]. Geneva: UNAIDS; 2025 (https://www.unaids.org/en/resources/fact-sheet).

4. Interim policy collaborative TB/HIV activities. Geneva: World Health Organization; 2004 (https://iris.who.int/handle/10665/78705).

5. WHO consolidated guidelines on tuberculosis, Module 4: Treatment and care. Geneva: World Health Organization; 2025 (https://iris.who.int/handle/10665/380799). License: CC BY-NC-SA 3.0 IGO.

6. WHO consolidated guidelines on tuberculosis: Module 5: Management of tuberculosis in children and adolescents. Geneva: World Health Organization; 2022 (https://iris.who.int/handle/10665/352522). License: CC BY-NC-SA 3.0 IGO.
  
<hr style="border:1px solid gray20">

**General disclaimers**
<br>
The designations employed and the presentation of the material in this publication do not imply the expression of any opinion whatsoever on the part of WHO concerning the legal status of any country, territory, city or area or of its authorities, or concerning the delimitation of its frontiers or boundaries. Dotted and dashed lines on maps represent approximate border lines for which there may not yet be full agreement.


```{r fig28, echo = FALSE, message=FALSE, warning = FALSE, fig.alt="pdf_main report_fig28_global success rate", eval=FALSE}
# this chunk is for saving .pdf and .csv for graphic design for PDF report - not web pages!

# fig 28
source(here('report/ch2-4_prepare_data.r')) # to load f2.4.5_data

f22_data <- rbind.data.frame(f2.3.7_data,f2.4.5_data) |>
    # Determine the order of subgroup for plotting
  mutate(subgroup = factor(subgroup,
                           levels = c("All people diagnosed with TB",
                                      "People living with HIV diagnosed with TB",
                                      "MDR/RR-TB cases"))) |>
  filter(subgroup != "People living with HIV diagnosed with TB", outcome == "Treatment success")

f22_plot <- f22_data |>
  
  ggplot(aes(year,
             value,
             color = subgroup)) +
 
  geom_line(size = 2) +

  theme_gtb() +
  
  theme(legend.direction='vertical') +

  scale_color_manual("", 
                    values = c("All people diagnosed with TB" = "dodgerblue3",
                               "MDR/RR-TB cases" = "firebrick3"),
                    labels = c("People newly diagnosed with TB (new and recurrent cases)\nand enrolled on first-line treatment", 
                               "People diagnosed with MDR/RR-TB and enrolled on an MDR/RR-TB treatment regimen")) +
  
  ylim(50,100) +

  labs(x="Year started on treatment", y="Treatment success rate (%)") +

  scale_x_continuous(breaks = seq(2012, report_year-2)) 

output_ggplot(f22_plot, f22_data, show_static = F, pdf_csv_folder, save_csv, save_pdf)

```



```{r js_functions}
# Insert javascript file containing common Kendo number formatting functions ----
cat(writeLines(readLines(here("report/resources/gtbr_js.htm"))))
```


<script type="text/javascript">
/* JSON data objects for the figures */

var fig_2_3_1_data = `r f2.3.1_data |> mutate(e_inc_num = e_inc_num/1e6, e_inc_num_lo = e_inc_num_lo/1e6,e_inc_num_hi = e_inc_num_hi/1e6, c_newinc = c_newinc/1e6) |> toJSON("rows")`   ;

var fig_2_3_2_data = `r f2.3.2_data |> toJSON("rows")`   ;

var fig_2_3_4_data = `r f2.3.4_data |> toJSON("rows")`   ;

var fig_2_3_4b_data = `r f2.3.4_region_data |> select(entity, year, hivpos, art, e_inc_tbhiv_num, e_inc_tbhiv_num_lo, e_inc_tbhiv_num_hi) |> toJSON("rows")`   ;

var fig_2_3_5_data = `r f2.3.5_data |> mutate(value = c_art, lo = c_art_lo, hi = c_art_hi) |> toJSON("rows")`   ;

var fig_2_3_6_data = `r f2.3.6_data |> pivot_wider(names_from = outcome, values_from = value) |> rename(succ=2, fail=3, died=4, ltfu=5, neval=6) |> toJSON("rows")` ;

var fig_2_3_7_data = `r f2.3.7_data |> pivot_wider(names_from = outcome, values_from = value) |> rename(succ=3, fail=4, died=5, ltfu=6, neval=7) |> arrange(rev(year)) |> toJSON("rows")` ;

var fig_2_3_8_data = `r f2.3.8_data |> pivot_wider(names_from = outcome, values_from = value) |> rename(succ=2, fail=3, died=4, ltfu=5, neval=6) |> toJSON("rows")` ;

var fig_2_3_9_data = `r f2.3.9_data |> pivot_wider(names_from = outcome, values_from = value) |> rename(succ=3, fail=4, died=5, ltfu=6, neval=7) |> arrange(rev(year)) |> toJSON("rows")` ;

var fig_2_3_10_data = `r f2.3.10_data  |> toJSON("rows")` ;

</script>

  
```{js, echo=FALSE}

/* Functions to create the figures */

function tb_format_thou_2(n) { 
  nt = n/1000; 
  if (nt < 100) {
    ntform = Number(nt.toPrecision(2))*1000;
      } else {
    ntform = Number(nt.toPrecision(3))*1000;
  } 
  return num_spacer(ntform)
}



function createFig_2_3_1(fig_ID, data, filter, fig_height) {
  
  		// Filter the dataset on the country variable
		dataJSON = data.filter( element => element.entity == filter);
  
		$(fig_ID).kendoChart({
			dataSource: dataJSON,
			chartArea: {
				height: fig_height
			},	
      title: {
				text: filter,
				color: "black",
				font: "bold 14px  Arial,Helvetica,sans-serif"
			},	
			legend: {
				position: "bottom"
			},
      series: [{
				type: "line",
				field: "e_inc_num",
				color: "#91A93E",	
				markers: {
          size: 3
        },
				tooltip: {
					visible: true,
					template: "TB incidence number (#= category #): #= value.toPrecision(3) # million"
				}
			},{
				type: "rangeArea",
				fromField: "e_inc_num_lo",
				toField: "e_inc_num_hi",
				color: "#91A93E",
				tooltip: {
					visible: true,
				template: "95% uncertainty interval of TB incidence number (#= category #): #= value.from.toPrecision(3) #\u2013#= value.to.toPrecision(3) # million"
				}
			},{
				type: "line",
				field: "c_newinc",
				color: "black",	
				markers: {
          size: 3
        },
				tooltip: {
					visible: true,
					template: "TB cases notified (#= category #): #= value.toPrecision(3) # million"
				}
			}],
			valueAxis: {
				labels: {
					template: "#= value.toPrecision(2) #"
 				},
				title: {
					text: "Millions per year"
				},
				line: {
					visible: false
				}
			},
			categoryAxis: {
				field: "year",
				labels: {
          step: 2
				},
				majorGridLines: {
					visible: false
				},
				title: {
					text: "Year"
				}
			}

		});
}

function createFig_2_3_2(fig_ID, data, filter, fig_height) {
  
  		// Filter the dataset on the country variable
		dataJSON = data.filter( element => element.country == filter);
  
		$(fig_ID).kendoChart({
			dataSource: dataJSON,
			chartArea: {
				height: fig_height
			},	
      title: {
				text: filter,
				color: "black",
				font: "bold 14px  Arial,Helvetica,sans-serif"
			},	
			legend: {
				position: "bottom"
			},
      series: [{
				type: "line",
				field: "e_inc_num",
				color: "#91A93E",	
				markers: {
          size: 3
        },
				tooltip: {
					visible: true,
					template: "TB incidence number (#= category #): #= tb_format_thou_2(value) #"
				}
			},{
				type: "rangeArea",
				fromField: "e_inc_num_lo",
				toField: "e_inc_num_hi",
				color: "#91A93E",
				tooltip: {
					visible: true,
				template: "95% uncertainty interval of TB incidence number (#= category #): #= tb_format_thou_2(value.from) #\u2013#= tb_format_thou_2(value.to) # "
				}
			},{
				type: "line",
				field: "c_newinc",
				color: "black",	
				markers: {
          size: 3
        },
				tooltip: {
					visible: true,
					template: "TB cases notified (#= category #): #= num_spacer(value) #"
				}
			}],
			valueAxis: {
				labels: {
					template: "#= axis_spacer(value) #"
 				},
				title: {
					text: "Number per year"
				},
				line: {
					visible: false
				}
			},
			categoryAxis: {
				field: "year",
				labels: {
          step: 3
				},
				majorGridLines: {
					visible: false
				},
				title: {
					text: "Year"
				}
			}

		});
}



function createFig_2_3_4(fig_ID, data) {
    
		$(fig_ID).kendoChart({
			dataSource: data,
			chartArea: {
				height: 500
			},
			title: {
				text: "Global",
				color: "black",
				font: "bold 14px  Arial,Helvetica,sans-serif"
			},	
			legend: {
				position: "bottom"
			},
      series: [{
				type: "line",
				field: "e_inc_tbhiv_num",
				color: "#ED1D24",
        markers: {
//				visible: false,
          size: 3
        },
				tooltip: {
					visible: true,
					format: "{0}",
					template: "Incident cases of TB among people living with HIV (#= category #): #= tb_format_thou(value) # 000"
				}
			},{
				type: "rangeArea",
				fromField: "e_inc_tbhiv_num_lo",
				toField: "e_inc_tbhiv_num_hi",
				color: "#ED1D24",
				tooltip: {
					visible: true,
				format: "{0}",
				template: "95% uncertainty interval (#= category #): #= tb_format_thou(value.from) # 000\u2013#= tb_format_thou(value.to) # 000"
				}
			},{
				type: "line",
				field: "hivpos",
				color: "black",		
        markers: {
//				visible: false,
          size: 3
        },
				tooltip: {
					visible: true,
					format: "{0}",
					template: "Number of people notified with a new or recurrent episode of TB who were known to be HIV-positive (#= category #): #= num_spacer(value) #"
				}
			},{
				type: "line",
				field: "art",
				color: "#277abe",		
        markers: {
//				visible: false,
          size: 3
        },
				tooltip: {
					visible: true,
					format: "{0}",
					template: "Number of TB patients who were started on antiretroviral therapy (#= category #): #= num_spacer(value) #"
				}
			},],
			valueAxis: {
				labels: {
          template: "#= axis_spacer(value/1e6) #"
				},
				title: {
					text: "New and recurrent cases per year (millions)",
					visible: true
				},
				line: {
					visible: false
				}
			},
			categoryAxis: {
				field: "year",
				labels: {
					rotation: "auto",
          step: 2
				},
				majorGridLines: {
					visible: false
				},
				title: {
					text: "Year",
					visible: true
				}
			}

		});
}

function createFig_2_3_4b(fig_ID, data, filter, height) {
   
  		// Filter the dataset on the country variable
		dataJSON = data.filter( element => element.entity == filter);
  
		$(fig_ID).kendoChart({
			dataSource: dataJSON,
			chartArea: {
				height: height
			},	
      title: {
				text: filter,
				color: "black",
				font: "bold 14px  Arial,Helvetica,sans-serif"
			},	
			legend: {
				position: "bottom"
			},
      series: [{
				type: "line",
				field: "e_inc_tbhiv_num",
				color: "#ED1D24",
        markers: {
//				visible: false,
          size: 3
        },
				tooltip: {
					visible: true,
					format: "{0}",
					template: "Incident cases of TB among people living with HIV (#= category #): #= tb_format_thou_2(value) #"
				}
			},{
				type: "rangeArea",
				fromField: "e_inc_tbhiv_num_lo",
				toField: "e_inc_tbhiv_num_hi",
				color: "#ED1D24",
				tooltip: {
					visible: true,
				format: "{0}",
				template: "95% uncertainty interval (#= category #): #= tb_format_thou_2(value.from) #\u2013#= tb_format_thou_2(value.to) #"
				}
			},{
				type: "line",
				field: "hivpos",
				color: "black",		
        markers: {
//				visible: false,
          size: 3
        },
				tooltip: {
					visible: true,
					format: "{0}",
					template: "Number of people notified with a new or recurrent episode of TB who were known to be HIV-positive (#= category #): #= num_spacer(value) #"
				}
			},{
				type: "line",
				field: "art",
				color: "#277abe",		
        markers: {
//				visible: false,
          size: 3
        },
				tooltip: {
					visible: true,
					format: "{0}",
					template: "Number of TB patients who were started on antiretroviral therapy (#= category #): #= num_spacer(value) #"
				}
			},],
			valueAxis: {
				labels: {
          template: "#= axis_spacer(value) #"
				},
				title: {
					text: "New and recurrent cases per year",
					visible: true
				},
				line: {
					visible: false
				}
			},
			categoryAxis: {
				field: "year",
				labels: {
					rotation: 0,
          step: 3
				},
				majorGridLines: {
					visible: false
				},
				title: {
					text: "Year",
					visible: true
				}
			}

		});
}

function createFig_2_3_5(fig_ID, data, color) {
   
		$(fig_ID).kendoChart({
			dataSource: data,
			chartArea: {
				height: 900
			},	
			legend: {
				position: "bottom"
			},
			series: [{
        type: "bar",
				field: 0,
				opacity: 0
			}, {
        type: "line",
				field: "value",
        errorLowField: "lo",
        errorHighField: "hi",
        errorBars: {color: color, line: { width: 3 }},
        opacity: 0,
				color: color,
        markers: {
          visible: true,
          background: color,
          size: 8
        },
        
			tooltip: {
				visible: true,
        background: color,
				template: "#= category #: #= tb_format_pct(value) #%"
			}
			},{
				type: "rangeArea",
				fromField: "lo",
				toField: "hi",
				opacity: 0,
        color: color,
				tooltip: {
					visible: true,
          background: color,
				format: "{0}",
				template: "95% uncertainty interval (#= category #): #= tb_format_pct(value.from) #\u2013#= tb_format_pct(value.to) #%"
				}
			}
              ],
			valueAxis: {
				labels: {
					format: "{0}"
				},
				title: {
					text: "Treatment coverage (%)"
				},
				line: {
					visible: false
				},
        min: 0,
			},
			categoryAxis: {
				field: "entity",
				labels: {
					rotation: "auto"
				},
				majorGridLines: {
					visible: true
				}
			}

		});
}


function createFig_2_3_6(fig_ID, data) {
		$(fig_ID).kendoChart({
			dataSource: data,
			chartArea: {
				height: 500
			},	
			legend: {
				position: "bottom"
			},
			seriesDefaults: {
				type: "bar",
        stack: true,
        gap: 0.2
			},
			series: [{
        name: "Treatment success",
				field: "succ",
				color: "#009E73",
        tooltip: {
				visible: true,
				template: "Treatment success (#= category #): #= value.toPrecision(2) #%"
			}
			},{
        name: "Treatment failed",
				field: "fail",
				color: "#ED1D24",
        tooltip: {
				visible: true,
				template: "Treatment failed (#= category #): #= value.toPrecision(2) #%"
			}
			},{
        name: "Died",
				field: "died",
				color: "#F7941E",
        tooltip: {
				visible: true,
				template: "Died (#= category #): #= value.toPrecision(2) #%"
			}
			},{
        name: "Lost to follow-up",
				field: "ltfu",
				color: "#E5DDB3",
        tooltip: {
				visible: true,
				template: "Lost to follow-up (#= category #): #= value.toPrecision(2) #%"
			}
			},{
        name: "Not evaluated",
				field: "neval",
				color: "#D1D3D4",
        tooltip: {
				visible: true,
				template: "Not evaluated (#= category #): #= value.toPrecision(2) #%"
			}
			},
              ],
			valueAxis: {

				title: {
					text: "Percentage of cohort"
				},
				line: {
					visible: false
				},
				min: 0,
        max: 100
			},
			categoryAxis: {
				field: "entity",
				labels: {
					rotation: "auto"
				},
				majorGridLines: {
					visible: false
				}			}
		});
}

function createFig_2_3_7(fig_ID, data, filter, x_axis_title = True, legend_label = True, height) {
      
  	// Filter the dataset on the country variable
		dataJSON = data.filter( element => element.subgroup == filter);
  
		$(fig_ID).kendoChart({
			dataSource: dataJSON,
			chartArea: {
				height: height
			},	
      title: {
				text: filter,
				color: "black",
				font: "bold 14px  Arial,Helvetica,sans-serif",
        align: "center"
			},	
			legend: {
				position: "bottom",
        visible: legend_label
			},
			seriesDefaults: {
				type: "bar",
        stack: true,
        gap: 0.2
			},
			series: [{
        name: "Treatment success",
				field: "succ",
				color: "#009E73",
        tooltip: {
				visible: true,
				template: "Treatment success (#= category #): #= value.toPrecision(2) #%"
			}
			},{
        name: "Treatment failed",
				field: "fail",
				color: "#ED1D24",
        tooltip: {
				visible: true,
				template: "Treatment failed (#= category #): #= value.toPrecision(2) #%"
			}
			},{
        name: "Died",
				field: "died",
				color: "#F7941E",
        tooltip: {
				visible: true,
				template: "Died (#= category #): #= value.toPrecision(2) #%"
			}
			},{
        name: "Lost to follow-up",
				field: "ltfu",
				color: "#E5DDB3",
        tooltip: {
				visible: true,
				template: "Lost to follow-up (#= category #): #= value.toPrecision(2) #%"
			}
			},{
        name: "Not evaluated",
				field: "neval",
				color: "#D1D3D4",
        tooltip: {
				visible: true,
				template: "Not evaluated (#= category #): #= value.toPrecision(2) #%"
			}
			},
              ],
			valueAxis: {
				title: {
					text: "Percent of cohort",
          visible: x_axis_title
				},
				line: {
					visible: false
				},
        min: 0,
        max: 100
			},
			categoryAxis: {
				field: "year",
				labels: {
					rotation: "auto"
				},
				majorGridLines: {
					visible: false
				}			}
		});
}

function createFig_2_3_10(fig_ID, data) {
		$(fig_ID).kendoChart({
			dataSource: data,
			chartArea: {
				height: 500
			},	
			legend: {
				position: "bottom",
				visible: false,
			},
			seriesDefaults: {
				type: "bar",
        gap: 0.2
			},
			series: [{
        name: "Treatment success",
				field: "c_tsr_014",
				color: "#009E73",
        tooltip: {
				visible: true,
				template: "Treatment success (#= category #): #= value.toPrecision(2) #%"
			}
			}
              ],
			valueAxis: {

				title: {
					text: "Percentage of cohort"
				},
				line: {
					visible: false
				},
				min: 0,
        max: 100
			},
			categoryAxis: {
				field: "entity",
				labels: {
					rotation: "auto"
				},
				majorGridLines: {
					visible: false
				}			}
		});
}

```


```{js, echo=FALSE}

/* Create the figures after the document has been loaded */

$(document).ready(function () {
  createFig_2_3_1("#fig_2_3_1_global",fig_2_3_1_data,"Global",500);
  createFig_2_3_1("#fig_2_3_1_afro",fig_2_3_1_data,"African Region",250);
  createFig_2_3_1("#fig_2_3_1_amro",fig_2_3_1_data,"Region of the Americas",250);
  createFig_2_3_1("#fig_2_3_1_searo",fig_2_3_1_data,"South-East Asia Region",250);
  createFig_2_3_1("#fig_2_3_1_euro",fig_2_3_1_data,"European Region",250);
  createFig_2_3_1("#fig_2_3_1_emro",fig_2_3_1_data,"Eastern Mediterranean Region",250);
  createFig_2_3_1("#fig_2_3_1_wpro",fig_2_3_1_data,"Western Pacific Region",250);

                  createFig_2_3_2("#fig_2_3_2_PHL",fig_2_3_2_data,"Philippines",250);
                  createFig_2_3_2("#fig_2_3_2_IND",fig_2_3_2_data,"India",250);
                  createFig_2_3_2("#fig_2_3_2_BRA",fig_2_3_2_data,"Brazil",250);
                  createFig_2_3_2("#fig_2_3_2_IDN",fig_2_3_2_data,"Indonesia",250);
                  createFig_2_3_2("#fig_2_3_2_LBR",fig_2_3_2_data,"Liberia",250);
                  createFig_2_3_2("#fig_2_3_2_GAB",fig_2_3_2_data,"Gabon",250);
                  createFig_2_3_2("#fig_2_3_2_KEN",fig_2_3_2_data,"Kenya",250);
                  createFig_2_3_2("#fig_2_3_2_PNG",fig_2_3_2_data,"Papua New Guinea",250);
                  createFig_2_3_2("#fig_2_3_2_BGD",fig_2_3_2_data,"Bangladesh",250);
                  createFig_2_3_2("#fig_2_3_2_UGA",fig_2_3_2_data,"Uganda",250);
                  createFig_2_3_2("#fig_2_3_2_PAK",fig_2_3_2_data,"Pakistan",250);
                  createFig_2_3_2("#fig_2_3_2_COG",fig_2_3_2_data,"Congo",250);
                  createFig_2_3_2("#fig_2_3_2_SLE",fig_2_3_2_data,"Sierra Leone",250);
                  createFig_2_3_2("#fig_2_3_2_LSO",fig_2_3_2_data,"Lesotho",250);
                  createFig_2_3_2("#fig_2_3_2_AGO",fig_2_3_2_data,"Angola",250);
                  createFig_2_3_2("#fig_2_3_2_MMR",fig_2_3_2_data,"Myanmar",250);
                  createFig_2_3_2("#fig_2_3_2_MNG",fig_2_3_2_data,"Mongolia",250);
                  createFig_2_3_2("#fig_2_3_2_VNM",fig_2_3_2_data,"Viet Nam",250);
                  createFig_2_3_2("#fig_2_3_2_THA",fig_2_3_2_data,"Thailand",250);
                  createFig_2_3_2("#fig_2_3_2_CAF",fig_2_3_2_data,"Central African Republic",250);
                  createFig_2_3_2("#fig_2_3_2_NGA",fig_2_3_2_data,"Nigeria",250);
                  createFig_2_3_2("#fig_2_3_2_COD",fig_2_3_2_data,"Democratic Republic\nof the Congo",250);
                  createFig_2_3_2("#fig_2_3_2_TZA",fig_2_3_2_data,"United Republic of Tanzania",250);
                  createFig_2_3_2("#fig_2_3_2_MOZ",fig_2_3_2_data,"Mozambique",250);
                  createFig_2_3_2("#fig_2_3_2_ZMB",fig_2_3_2_data,"Zambia",250);
                  createFig_2_3_2("#fig_2_3_2_CHN",fig_2_3_2_data,"China",250);
                  createFig_2_3_2("#fig_2_3_2_NAM",fig_2_3_2_data,"Namibia",250);
                  createFig_2_3_2("#fig_2_3_2_PRK",fig_2_3_2_data,"Democratic People's\nRepublic of Korea",250);
                  createFig_2_3_2("#fig_2_3_2_ZAF",fig_2_3_2_data,"South Africa",250);
                  createFig_2_3_2("#fig_2_3_2_ETH",fig_2_3_2_data,"Ethiopia",250);


  createFig_2_3_4("#fig_2_3_4",fig_2_3_4_data);
  
  createFig_2_3_4b("#fig_2_3_4_afro",fig_2_3_4b_data,"African Region",250);
  createFig_2_3_4b("#fig_2_3_4_amro",fig_2_3_4b_data,"Region of the Americas",250);
  createFig_2_3_4b("#fig_2_3_4_searo",fig_2_3_4b_data,"South-East Asia Region",250);
  createFig_2_3_4b("#fig_2_3_4_euro",fig_2_3_4b_data,"European Region",250);
  createFig_2_3_4b("#fig_2_3_4_emro",fig_2_3_4b_data,"Eastern Mediterranean Region",250);
  createFig_2_3_4b("#fig_2_3_4_wpro",fig_2_3_4b_data,"Western Pacific Region",250);
  
  createFig_2_3_5("#fig_2_3_5",fig_2_3_5_data,"#ed6476");
  
  createFig_2_3_6("#fig_2_3_6",fig_2_3_6_data);
  createFig_2_3_7("#fig_2_3_7a",fig_2_3_7_data,"All people diagnosed with TB",false,false,400);
  createFig_2_3_7("#fig_2_3_7b",fig_2_3_7_data,"People living with HIV diagnosed with TB",true,true,470);

  createFig_2_3_6("#fig_2_3_8",fig_2_3_8_data);

  createFig_2_3_7("#fig_2_3_9a",fig_2_3_9_data,"Female",false,false,300);
  createFig_2_3_7("#fig_2_3_9b",fig_2_3_9_data,"Male",true,true,370);
  
  createFig_2_3_10("#fig_2_3_10",fig_2_3_10_data);

 }); 
 
```
