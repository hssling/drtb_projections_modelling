---
title: "Section 2.2 Diagnostic testing"
author: "Takuya Yamanaka"
date: "`r Sys.Date()`"
knit: (function(inputFile, encoding) {
      out_dir <- "./local";
      rmarkdown::render(inputFile,
                        encoding=encoding,
                        output_dir=file.path(dirname(inputFile), out_dir))})
output: 
  html_fragment:
    # Do not include a table of contents
    toc: no
    # Set standard figure width to 12 inches
    fig_width: 12
    # Do not write figure captions
    fig_caption: FALSE
    # to save intermediate .png
    keep_md: False 
    # Don't embed external resources (stylesheets, JS libraries) in the output 
    self_contained: False
    # Don't include <div> tags around a header and the content found until the next header
    section_divs: FALSE  

---


```{r setup, include=FALSE}
# Set chunk options.
# Results "asis" is useful to output markdown from a function
# Suppress messages, warnings and also the ## at the beginning of printed text

knitr::opts_chunk$set(echo = FALSE, 
                      results = "asis",
                      message = FALSE,
                      warning = FALSE,
                      error = TRUE, # for debugging!
                      
                      # Settings for better output of whomapper .png maps
                      fig.width = 10,
                      fig.height = 5,
                      dpi = 350
                      )

# Kill any attempt at using factors, unless we explicitly want them!
options(stringsAsFactors=FALSE)

# Load output packages ----
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
library(ggplot2)
library(dplyr)
library(scales)
library(RColorBrewer)
# devtools::install_github("yamanakatakuya/whomapR")
# from https://github.com/yamanakatakuya/whomapR
library(whomapR)
library(gtbreport)
library(here)
library(readr)

library(english) # to covert numbers to texts (e.g. 6 to six)

# Load R functions ----
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
source(here("report/functions/html_links.R"))
source(here("report/functions/output_ggplot.R"))

# Load standard note about Indonesia moving to WPR ----
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
source(here("report/resources/IDN_2_WPR_note.R"))

# Get the data sets and computed values/statistics for section 2.2 ----
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - 
source(here('report/ch2-2_prepare_data.r'))
source(here('report/ch2-1_prepare_data.r')) # for a text to refer numbers from table 2.1.1

# Show static chart in addition to Kendo chart?
show_static = F

# Save underlying data files as CSV and charts as PDF files?
pdf_csv_folder = here::here("report/local/figures/ch2.2")
save_csv = TRUE
save_pdf = TRUE
save_hidef = FALSE # TRUE only for producing a high definition map for the PDF!

# Create the output folder (only if it doesn't yet exist)
dir.create(pdf_csv_folder, showWarnings = FALSE, recursive = TRUE)

```


```{r css_js}
# Add standard stylesheets and javascript to support kendo
cat(writeLines(readLines(here("report/resources/headers.htm"))))
```

# 2.2 Diagnostic testing   

<span class="red">**Draft! Prepared `r Sys.Date()` using country-reported data snapshot files from `r format(as.Date(snapshot_date), format="%d %B %Y")`!**</span>

An essential step in the pathway of tuberculosis (TB) care is rapid and accurate diagnostic testing. Since 2011, rapid molecular tests that are highly specific and sensitive have transformed the TB diagnostic landscape, which previously relied upon more traditional microscopy and culture methods. 

People diagnosed with TB using rapid molecular tests recommended by WHO (`r ref_lnk("1")`), lateral flow urine lipoarabinomannan (LF-LAM) assays, sputum smear microscopy or culture are defined as "bacteriologically confirmed" cases of TB (`r ref_lnk("2")`). The microbiological detection of TB is critical because it allows people to be correctly diagnosed and started on the most effective treatment regimen as early as possible. People diagnosed with TB in the absence of bacteriological confirmation are referred to as "clinically diagnosed" or "bacteriologically unconfirmed" cases of TB (`r ref_lnk("2")`,`r ref_lnk("3")`). 

Bacteriological confirmation of TB is necessary to test for resistance to anti-TB drugs. This can be done using rapid molecular tests, phenotypic susceptibility testing or genetic sequencing.

`r lnk("Fig. 2.2.1")` provides an overview of global numbers in 2024 related to diagnostic testing for TB as well as resistance to two first-line drugs: rifampicin and isoniazid. 

### `r anch("Fig. 2.2.1")`<span class="red">Fig. 2.2.1</span> Global overview of numbers^a^ related to TB diagnosis as well as testing for resistance to rifampicin and isoniazid, `r report_year - 1`

```{r fig_2.2.1, fig.alt="Bar chart of cascade of TB diagnostic testing)"}

f2.2.1_plot <- f2.2.1_data |> 
  filter(entity == "Global") |>
  ggplot(aes(x=stage, y=how_many/1e6)) +
  geom_bar(stat="identity", fill="seagreen4",width = 0.5) +
  # facet_wrap( ~ entity, ncol = 3, scales="free_y") +
  ylab("Number of people (millions)") +

  xlab("") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  theme_gtb() 

output_ggplot(f2.2.1_plot, f2.2.1_data, show_static, pdf_csv_folder, save_csv, save_pdf)
 
```

<div id="fig_2_2_1_global"></div>

<div class="footnote">WRD: WHO-recommended rapid diagnostic test.
<br>^a^ Numbers in the first 4 bars refer to people with a new episode of TB (new or recurrent cases). Numbers in the last two bars are for people with a new episode of TB as well as for people with re-registered for TB.</div>

<hr />
<br />

## Rapid diagnostic testing

At the second United Nations (UN) high-level meeting on TB in 2023, Member States adopted a new target that, by 2027, 100% of people diagnosed with TB should be initially tested with a WHO-recommended rapid diagnostic test (WRD) (`r ref_lnk("4")`).

Globally, there is a big gap between the number of people newly diagnosed with TB and the number of these people who were initially tested with a WRD (`r lnk("Fig. 2.2.1")`). 

A WRD was used as the initial diagnostic test for `r ftb(f2.2.2_txt$wrd_pcnt_2024)`% (`r ftb(f2.2.2_txt$newinc_rdx_2024/1e6)` million) of the `r ftb(f2.2.2_txt$c_newinc_2024/1e6)` million people newly diagnosed with TB in `r report_year-1`, an increase from `r ftb(f2.2.2_txt$wrd_pcnt_2023)`% (out of a total of `r ftb(f2.2.2_txt$c_newinc_2023/1e6)` million) in `r report_year-2` and up from `r ftb(f2.2.2_txt$wrd_pcnt_2022)`% (out of a total of `r ftb(f2.2.2_txt$c_newinc_2022/1e6)` million) in `r report_year-3` (`r lnk("Fig. 2.2.2")`). Among WHO regions, the best level of coverage was achieved in the European Region (`r ftb(f2.2.2_txt$euro)`%) and the Western Pacific Region (`r ftb(f2.2.2_txt$wpro)`%); the lowest coverage was in the South-East Asia Region (`r ftb(f2.2.2_txt$searo)`%). 

### `r anch("Fig. 2.2.2")`<span class="red">Fig. 2.2.2</span> Percentage of people newly diagnosed with TB who were initially tested with a WHO-recommended rapid diagnostic test (WRD), globally and for WHO regions, 2015&#8211;`r report_year-1`^a^
<div class="subhead">`r IDN_2_WPR_note`</div>

```{r fig_2.2.2, fig.alt="global trend: percent of TB cases tested with rapid diagnostics"}

f2.2.2_plot <- f2.2.2_data |> 
  
  ggplot(aes(x=year, y=wrd_pcnt)) +
  geom_line(size = 1.5, colour = "blueviolet") +
  scale_x_continuous(name="Year",
                     breaks = c(2015, 2017, 2019, 2021, report_year-1)) +
  scale_y_continuous(name = "Percentage") +
  expand_limits(y=c(0,100)) +
  
  facet_wrap( ~ entity, ncol = 4) +

  theme_gtb() +
  
  # Get rid of annoying x-axis line and ticks
  theme(axis.line.x = ggplot2::element_blank(),
        axis.ticks.x = element_blank())

output_ggplot(f2.2.2_plot, f2.2.2_data, show_static, pdf_csv_folder, save_csv, save_pdf)

```

<div id="fig_2_2_2"></div>

<div class="row">
<div class="col-md-4">
<div id="fig_2_2_2_afro"></div>
</div>
<div class="col-md-4">
<div id="fig_2_2_2_amro"></div>
</div>
<div class="col-md-4">
<div id="fig_2_2_2_searo"></div>
</div>
</div>

<div class="row">
<div class="col-md-4">
<div id="fig_2_2_2_euro"></div>
</div>
<div class="col-md-4">
<div id="fig_2_2_2_emro"></div>
</div>
<div class="col-md-4">
<div id="fig_2_2_2_wpro"></div>
</div>
</div>
<div class="footnote">^a^ Data are for notified cases.</div>

<hr />
<br />
Use of WRDs varied substantially among countries in `r report_year-1` (`r lnk("Fig. 2.2.3")`). 

### `r anch("Fig. 2.2.3")`<span class="red">Fig. 2.2.3</span> Percentage of people newly diagnosed with TB who were initially tested with a WHO-recommended rapid diagnostic test (WRD),^a^ `r report_year-1`

```{r fig_2.2.3, fig.alt="World map showing percent of TB cases tested with rapid diagnostics"}

if (save_hidef == TRUE) {
  # Generate a high definition map for the PDF
  # Update fig numbering according to the masterlist of figs/tables
  f19_data <- f2.2.3_data
  
  f19_plot <- f19_data |> 
  
  whomapper(colours = brewer.pal(5, "Purples"),
         legend_title = "", hidef = save_hidef, legend_pos = "none")

output_ggplot(f19_plot, f19_data, show_static, pdf_csv_folder, save_csv, save_pdf)
  
} else {
  # Generate a standard map for the web page
  
  f2.2.3_plot <- f2.2.3_data |> 
  
  whomapper(colours = brewer.pal(5, "Purples"),
         legend_title = "Percentage (%)")

output_ggplot(f2.2.3_plot, f2.2.3_data, show_static = TRUE, pdf_csv_folder, save_csv, save_pdf)

}




```
<div class="footnote">^a^ Data are for notified cases.</div>

<hr />
<br />
Among the 30 high TB burden countries, those with high proportions (&#8805;80%) of people newly diagnosed with TB who were initially tested with a WRD in `r report_year-1` included `r knitr::combine_words(f2.2.3_txt_list$country_in_text_EN, oxford_comma=FALSE)` (`r lnk("Fig. 2.2.4")`). 

Among the 49 countries in one of the three global lists of high burden countries (for TB, HIV-associated TB and MDR/RR-TB) being used by WHO in the period 2021&#8211;2025 (<span class="red">Annex 3</span> of the core report document), `r f2.2.2_txt$hbcs_2024` reported that a WRD had been used as the initial test for more than half of their notified TB cases in `r report_year-1`, up from `r f2.2.2_txt$hbcs_2023` in `r report_year-2`. 

### `r anch("Fig. 2.2.4")`<span class="red">Fig. 2.2.4</span> Percentage of people newly diagnosed with TB who were initially tested with a WHO-recommended rapid diagnostic test (WRD), 30 high TB burden countries, 2015&#8211;`r report_year-1`

```{r fig_2.2.4, fig.alt="trend showing percent of TB cases tested with rapid diagnostics", fig.height=12}

f2.2.4_plot <- f2.2.4_data |> 
  filter(!is.na(wrd_pcnt)) |>
  ggplot(aes(x=year, y=wrd_pcnt)) +
  geom_line(size = 1.5, colour = "blueviolet") +
  scale_x_continuous(name="Year",
                     breaks = c(2015, 2017, 2019, 2021, report_year-1)) +
  scale_y_continuous(name = "Percentage") +
  expand_limits(y=c(0,100)) +
  facet_wrap( ~ entity, 
              scales="free_y",
              ncol = 5,
              # Use the labeller function to make sure long country names are wrapped in panel headers
              labeller = label_wrap_gen(width = 20)) +

  theme_gtb() +
  
  # Get rid of annoying x-axis line and ticks
  theme(axis.line.x = ggplot2::element_blank(),
        axis.ticks.x = element_blank())

output_ggplot(f2.2.4_plot, f2.2.4_data, show_static, pdf_csv_folder, save_csv, save_pdf)

```

<div class="row">
<div class="col-md-4">
<div id="fig_2_2_4_AGO"></div>
</div>
<div class="col-md-4">
<div id="fig_2_2_4_BGD"></div>
</div>
<div class="col-md-4">
<div id="fig_2_2_4_BRA"></div>
</div>
</div>

<div class="row">
<div class="col-md-4">
<div id="fig_2_2_4_CAF"></div>
</div>
<div class="col-md-4">
<div id="fig_2_2_4_CHN"></div>
</div>
<div class="col-md-4">
<div id="fig_2_2_4_COG"></div>
</div>
</div>

<div class="row">
<div class="col-md-4">
<div id="fig_2_2_4_PRK"></div>
</div>
<div class="col-md-4">
<div id="fig_2_2_4_COD"></div>
</div>
<div class="col-md-4">
<div id="fig_2_2_4_ETH"></div>
</div>
</div>

<div class="row">
<div class="col-md-4">
<div id="fig_2_2_4_GAB"></div>
</div>
<div class="col-md-4">
<div id="fig_2_2_4_IND"></div>
</div>
<div class="col-md-4">
<div id="fig_2_2_4_IDN"></div>
</div>
</div>

<div class="row">
<div class="col-md-4">
<div id="fig_2_2_4_KEN"></div>
</div>
<div class="col-md-4">
<div id="fig_2_2_4_LSO"></div>
</div>
<div class="col-md-4">
<div id="fig_2_2_4_LBR"></div>
</div>
</div>

<div class="row">
<div class="col-md-4">
<div id="fig_2_2_4_MNG"></div>
</div>
<div class="col-md-4">
<div id="fig_2_2_4_MOZ"></div>
</div>
<div class="col-md-4">
<div id="fig_2_2_4_MMR"></div>
</div>
</div>

<div class="row">
<div class="col-md-4">
<div id="fig_2_2_4_NAM"></div>
</div>
<div class="col-md-4">
<div id="fig_2_2_4_NGA"></div>
</div>
<div class="col-md-4">
<div id="fig_2_2_4_PAK"></div>
</div>
</div>

<div class="row">
<div class="col-md-4">
<div id="fig_2_2_4_PNG"></div>
</div>
<div class="col-md-4">
<div id="fig_2_2_4_PHL"></div>
</div>
<div class="col-md-4">
<div id="fig_2_2_4_SLE"></div>
</div>
</div>

<div class="row">
<div class="col-md-4">
<div id="fig_2_2_4_ZAF"></div>
</div>
<div class="col-md-4">
<div id="fig_2_2_4_THA"></div>
</div>
<div class="col-md-4">
<div id="fig_2_2_4_UGA"></div>
</div>
</div>

<div class="row">
<div class="col-md-4">
<div id="fig_2_2_4_TZA"></div>
</div>
<div class="col-md-4">
<div id="fig_2_2_4_VNM"></div>
</div>
<div class="col-md-4">
<div id="fig_2_2_4_ZMB"></div>
</div>
</div>

<hr />
<br />
A major influence on the coverage of rapid testing is the proportion of TB diagnostic sites with access to WRDs. In `r report_year-1`, this varied considerably by country (`r lnk("Fig. 2.2.5")`). Only `r as.character(english(f2.2.5_country_txt |> nrow()))` of the 30 high TB burden countries reported that more than 50% of their TB diagnostic sites had access to WRDs: `r knitr::combine_words(f2.2.5_country_txt$country_in_text_EN, oxford_comma=FALSE)`. This list was unchanged compared with `r report_year-2`. Expanding access to TB diagnosis using rapid tests should be a top priority for all countries. 

### `r anch("Fig. 2.2.5")`<span class="red">Fig. 2.2.5</span> Proportion of diagnostic sites for TB with access to WHO-recommended rapid diagnostic tests (WRDs), by country, `r report_year-1`

```{r fig_2.2.5, fig.alt="World map showing proportion of diagnostic sites with WRDs"}

f2.2.5_plot <- f2.2.5_data |> 
  
  whomapper(colours = brewer.pal(5, "Blues"),
         legend_title = "Proportion (%)")

output_ggplot(f2.2.5_plot, f2.2.5_data, show_static = TRUE, pdf_csv_folder, save_csv, save_pdf)
```

<hr />
<br />




## Bacteriological confirmation

A global total of `r ftb(f2.2.6_txt$c_newinc/1e6)` million people were newly diagnosed with TB and notified as a TB case in `r report_year-1`; of these, `r ftb(f2.2.6_txt$pulm/1e6)` million (`r ftb(f2.2.6_txt$pulm_pct)`%) had pulmonary TB (`r lnk("Fig. 2.2.1")`, <span class="red">Table 2.1.1 of Section 2.1</span>). Worldwide, the percentage of people diagnosed with pulmonary TB based on bacteriological confirmation improved between 2018 and 2021, from `r ftb(f2.2.6_txt$bc_pct_2018)`% to `r ftb(f2.2.6_txt$bc_pct_2021)`%; however, it remained relatively stable, at `r ftb(f2.2.6_txt$bc_pct_2023)`%&#8211;`r ftb(f2.2.6_txt$bc_pct_2024)`%, in 2022&#8211;`r report_year-1` (`r lnk("Fig. 2.2.6")`).
Among the six WHO regions, there were steady improvements between 2020 and `r report_year-1` in the African Region (from `r ftb(f2.2.6_region_txt$bc_pct_AFR_2020)`% to `r ftb(f2.2.6_region_txt$bc_pct_AFR_2024)`%) and the Region of the Americas (from `r ftb(f2.2.6_region_txt$bc_pct_AMR_2020)`% to `r ftb(f2.2.6_region_txt$bc_pct_AMR_2024)`%); in other regions, levels of bacteriological confirmation were either stable or fell slightly. Efforts to reach the level already achieved in the Region of the Americas are required in other regions.


### `r anch("Fig. 2.2.6")`<span class="red">Fig. 2.2.6</span> Percentage of people newly diagnosed with pulmonary TB who were bacteriologically confirmed, globally and for WHO regions,^a^ 2010&#8211;`r report_year-1`
<div class="subhead">`r IDN_2_WPR_note`</div>

```{r fig_2.2.6, fig.alt="Panel plot of TB cases with bacteriological confirmation by WHO region and globally since 2010"}

f2.2.6_plot <- f2.2.6_data |> 
  
  ggplot(aes(x=year, y=bacconf_pct)) +
    geom_line(size = 1.5, colour = "seagreen4") +
    scale_x_continuous(name="Year",
                       breaks = c(2000, 2005, 2010, 2015, report_year-1)) +
    scale_y_continuous(name = "Percentage bacteriologically confirmed") +
    expand_limits(y=c(0,100)) +
    facet_wrap( ~ entity, ncol = 4) +

    theme_gtb() +
  
  # Get rid of annoying x-axis line and ticks
  theme(axis.line.x = ggplot2::element_blank(),
        axis.ticks.x = element_blank())


output_ggplot(f2.2.6_plot, f2.2.6_data, show_static, pdf_csv_folder, save_csv, save_pdf)

```
<div id="fig_2_2_6_global"></div>

<div class="row">
<div class="col-md-4">
<div id="fig_2_2_6_afro"></div>
</div>
<div class="col-md-4">
<div id="fig_2_2_6_amro"></div>
</div>
<div class="col-md-4">
<div id="fig_2_2_6_searo"></div>
</div>
</div>

<div class="row">
<div class="col-md-4">
<div id="fig_2_2_6_euro"></div>
</div>
<div class="col-md-4">
<div id="fig_2_2_6_emro"></div>
</div>
<div class="col-md-4">
<div id="fig_2_2_6_wpro"></div>
</div>
</div>

<div class="footnote">^a^ Data are for notified cases. The calculation for years prior to 2013 is based on smear results, except for the European Region where data on confirmation by culture were also available for the period 2010&#8211;2012.</div>


<hr />
<br />
In `r report_year-1`, there was considerable country variation in the proportion of people newly diagnosed with pulmonary TB who were bacteriologically confirmed (`r lnk("Fig. 2.2.7")`). 

### `r anch("Fig. 2.2.7")`<span class="red">Fig. 2.2.7</span> Percentage of people newly diagnosed with pulmonary TB who were bacteriologically confirmed, by country,^a^ `r report_year-1`

```{r fig_2.2.7, fig.alt="World map showing percent of TB cases with bacteriological confirmation"}

f2.2.7_plot <- f2.2.7_data |> 

  whomapper(colours = brewer.pal(4, "Greens"),
         legend_title = "Percentage (%)")


output_ggplot(f2.2.7_plot, f2.2.7_data, show_static = TRUE, pdf_csv_folder, save_csv, save_pdf)

```

<div class="footnote">^a^ Data are for notified cases.</div>


<hr />
<br />
In the 30 high TB burden countries (`r lnk("Fig. 2.2.8")`), variation in the proportion of people diagnosed with pulmonary TB who were bacteriologically confirmed likely reflects differences in diagnostic and reporting practices, including access to rapid diagnostic tests. The countries with relatively high levels of bacteriological confirmation in `r report_year-1` (75% or above) were `r knitr::combine_words(f2.2.8_txt_list_hi$country_in_text_EN, oxford_comma=FALSE)`. 

There is clear scope for improvement in most other high TB burden countries. This is particularly needed in `rknitr::combine_words(f2.2.8_txt_list_lo$country_in_text_EN, oxford_comma=FALSE)`, where levels of bacteriological confirmation remained around or below 50% in `r report_year-1`. Such levels of bacteriological confirmation show overdependence on clinical diagnosis of TB and potentially over-diagnosis. When the proportion of people diagnosed with pulmonary TB based on bacteriological confirmation falls to around or below 50%, a review of the diagnostic tests in use and the validity of clinical diagnoses is warranted (e.g. via a clinical audit).

Among other 30 high TB burden countries, four have made considerable progress in recent years: China, the Congo, Ethiopia and Thailand. 

### `r anch("Fig. 2.2.8")`<span class="red">Fig. 2.2.8</span> Percentage of people newly diagnosed with pulmonary TB who were bacteriologically confirmed, 30 high TB burden countries,^a^ 2010&#8211;`r report_year-1`

```{r fig_2.2.8, fig.alt="Panel plot of TB cases with bacteriological confirmation for 30 countries since 2010", fig.height=12}

f2.2.8_plot <- f2.2.8_data |> 
  
  ggplot(aes(x=year, y=bacconf_pct)) +
  geom_line(size = 1.5, colour = "seagreen4") +
  scale_x_continuous(name="Year",
                     breaks = c(2000, 2010, report_year-1)) +
  scale_y_continuous(name = "Percentage bacteriologically confirmed") +
  expand_limits(y=c(0,100)) +
  facet_wrap( ~ country, 
              scales="free_y",
              ncol = 5,
              # Use the labeller function to make sure long country names are wrapped in panel headers
              labeller = label_wrap_gen(width = 20)) +

  theme_gtb() +
  
  # Get rid of annoying x-axis line and ticks
  theme(axis.line.x = ggplot2::element_blank(),
        axis.ticks.x = element_blank())

output_ggplot(f2.2.8_plot, f2.2.8_data, show_static, pdf_csv_folder, save_csv, save_pdf)

```
<div class="row">
<div class="col-md-4">
<div id="fig_2_2_8_AGO"></div>
</div>
<div class="col-md-4">
<div id="fig_2_2_8_BGD"></div>
</div>
<div class="col-md-4">
<div id="fig_2_2_8_BRA"></div>
</div>
</div>

<div class="row">
<div class="col-md-4">
<div id="fig_2_2_8_CAF"></div>
</div>
<div class="col-md-4">
<div id="fig_2_2_8_CHN"></div>
</div>
<div class="col-md-4">
<div id="fig_2_2_8_COG"></div>
</div>
</div>

<div class="row">
<div class="col-md-4">
<div id="fig_2_2_8_PRK"></div>
</div>
<div class="col-md-4">
<div id="fig_2_2_8_COD"></div>
</div>
<div class="col-md-4">
<div id="fig_2_2_8_ETH"></div>
</div>
</div>

<div class="row">
<div class="col-md-4">
<div id="fig_2_2_8_GAB"></div>
</div>
<div class="col-md-4">
<div id="fig_2_2_8_IND"></div>
</div>
<div class="col-md-4">
<div id="fig_2_2_8_IDN"></div>
</div>
</div>

<div class="row">
<div class="col-md-4">
<div id="fig_2_2_8_KEN"></div>
</div>
<div class="col-md-4">
<div id="fig_2_2_8_LSO"></div>
</div>
<div class="col-md-4">
<div id="fig_2_2_8_LBR"></div>
</div>
</div>

<div class="row">
<div class="col-md-4">
<div id="fig_2_2_8_MNG"></div>
</div>
<div class="col-md-4">
<div id="fig_2_2_8_MOZ"></div>
</div>
<div class="col-md-4">
<div id="fig_2_2_8_MMR"></div>
</div>
</div>

<div class="row">
<div class="col-md-4">
<div id="fig_2_2_8_NAM"></div>
</div>
<div class="col-md-4">
<div id="fig_2_2_8_NGA"></div>
</div>
<div class="col-md-4">
<div id="fig_2_2_8_PAK"></div>
</div>
</div>

<div class="row">
<div class="col-md-4">
<div id="fig_2_2_8_PNG"></div>
</div>
<div class="col-md-4">
<div id="fig_2_2_8_PHL"></div>
</div>
<div class="col-md-4">
<div id="fig_2_2_8_SLE"></div>
</div>
</div>

<div class="row">
<div class="col-md-4">
<div id="fig_2_2_8_ZAF"></div>
</div>
<div class="col-md-4">
<div id="fig_2_2_8_THA"></div>
</div>
<div class="col-md-4">
<div id="fig_2_2_8_UGA"></div>
</div>
</div>

<div class="row">
<div class="col-md-4">
<div id="fig_2_2_8_TZA"></div>
</div>
<div class="col-md-4">
<div id="fig_2_2_8_VNM"></div>
</div>
<div class="col-md-4">
<div id="fig_2_2_8_ZMB"></div>
</div>
</div>

<div class="footnote">^a^ Data are for notified cases.</div>


<hr />
<br />


## Resistance to rifampicin

Bacteriological confirmation of TB is required to test for drug resistance. 
To ensure that people are enrolled on the right TB treatment regimen, all those diagnosed with bacteriologically confirmed TB should be tested for resistance to rifampicin (the most effective first-line anti-TB drug) (`r ref_lnk("5")`). 

Globally in `r report_year-1`, `r ftb(f2.2.9_txt$dst_pct_Global_2024)`% of people with bacteriologically confirmed TB were tested for rifampicin-resistance TB (RR-TB), an improvement from `r ftb(f2.2.9_txt$dst_pct_Global_2023)`% in 2023 and major progress compared with `r ftb(f2.2.9_txt$dst_pct_Global_2021)`% in `r report_year-4` (`r lnk("Fig. 2.2.9")`). There has been substantial progress in recent years in all six WHO regions. In `r report_year-1`, the highest coverage of testing (&#8805;80%) was in the European, South-East Asia and Western Pacific regions. 

### `r anch("Fig. 2.2.9")`<span class="red">Fig. 2.2.9</span> Percentage of people diagnosed with bacteriologically confirmed TB who were tested for rifampicin-resistant TB (RR-TB^a^), globally and for WHO regions, 2010&#8211;`r report_year-1`
<div class="subhead">`r IDN_2_WPR_note`</div>

```{r fig_2.2.9, fig.alt="Panel plot of TB cases tested for susceptibility to rifampicin by WHO region and globally"}

f2.2.9_plot <- f2.2.9_data |> 
  
  ggplot(aes(x=year, y=dst_pcnt, ymin=0)) +
  geom_line(size = 1.5, colour = "#e52000") +

  facet_wrap( ~ entity, ncol = 4, scales="fixed") +
  scale_x_continuous(breaks = c(2009, 2015, report_year-1)) +
  scale_y_continuous(name = "Percentage tested") +
  expand_limits(y=c(0,100)) +
  xlab("Year") +

  theme_gtb() +
  
  # Get rid of annoying x-axis line and ticks
  theme(axis.line.x = ggplot2::element_blank(),
        axis.ticks.x = element_blank())

output_ggplot(f2.2.9_plot, f2.2.9_data, show_static, pdf_csv_folder, save_csv, save_pdf)

```
<div id="fig_2_2_9_global"></div>

<div class="row">
<div class="col-md-4">
<div id="fig_2_2_9_afro"></div>
</div>
<div class="col-md-4">
<div id="fig_2_2_9_amro"></div>
</div>
<div class="col-md-4">
<div id="fig_2_2_9_searo"></div>
</div>
</div>

<div class="row">
<div class="col-md-4">
<div id="fig_2_2_9_euro"></div>
</div>
<div class="col-md-4">
<div id="fig_2_2_9_emro"></div>
</div>
<div class="col-md-4">
<div id="fig_2_2_9_wpro"></div>
</div>
</div>

<div class="footnote">^a^ Includes both new and previously treated cases; data for 2017 onwards are for pulmonary cases only.</div>

<hr />
<br />


In `r report_year-1`, there was considerable variation among countries in the coverage of testing for RR-TB (`r lnk("Fig. 2.2.10")`). Of the 30 countries (see <span class="red">Annex 3</span> of the core report document) that WHO has defined as high burden for multidrug-resistant/RR-TB (MDR/RR-TB; MDR-TB is defined as resistance to both rifampicin and isoniazid), `r nrow(f2.2.10_txt)` reached a coverage of at least 80% in `r report_year-1`: `r knitr::combine_words(f2.2.10_txt$country_in_text_EN, oxford_comma=FALSE)`. There were `r int2word(f2.2.10_low_txt |> nrow())` high MDR/RR-TB burden countries that did not reach a coverage level of 50%: `r knitr::combine_words(f2.2.10_low_txt |> slice(1) |> select(country_in_text_EN), oxford_comma=FALSE)` (`r ftb(f2.2.10_low_txt |> slice(1) |> select(dst_pct))`%), `r knitr::combine_words(f2.2.10_low_txt |> slice(2) |> select(country_in_text_EN), oxford_comma=FALSE)` (`r ftb(f2.2.10_low_txt |> slice(2) |> select(dst_pct))`%) and `r knitr::combine_words(f2.2.10_low_txt |> slice(3) |> select(country_in_text_EN), oxford_comma=FALSE)` (`r ftb(f2.2.10_low_txt |> slice(3) |> select(dst_pct))`%). 

### `r anch("Fig. 2.2.10")`<span class="red">Fig. 2.2.10</span> Percentage of people diagnosed with bacteriologically confirmed TB who were tested for rifampicin-resistant TB (RR-TB^a^), by country, `r report_year-1`

```{r fig_2.2.10, fig.alt="World map showing percent of TB cases tested for susceptibility to rifampicin"}

f2.2.10_plot <- f2.2.10_data |> 
  
  whomapper(colours = brewer.pal(4, "Reds"),
         legend_title = "Percentage (%)")

output_ggplot(f2.2.10_plot, f2.2.10_data, show_static = TRUE, pdf_csv_folder, save_csv, save_pdf)

```
<div class="footnote">^a^ Includes both new and previously treated cases; data are for pulmonary cases only.</div>

<br />
Among people tested for RR-TB, a total of `r int_spacer(f2.2.9_txt$conf_rr_nfqr_2024)` cases of MDR/RR-TB and `r int_spacer(f2.2.9_txt$conf_rr_fqr_2024)` cases of pre-extensively drug-resistant TB (pre-XDR-TB) or XDR-TB were notified in `r report_year-1` (<span class="red">Table 2.1.1</span>), for a combined total of `r int_spacer(f2.2.12_txt$rr_nfqr_fqr_2024)`. This was a decrease (`r round(f2.2.12_txt$rr_nfqr_pct_dif_2024,1)`%) from a combined total of `r int_spacer(f2.2.12_txt$rr_nfqr_fqr_2023)` in `r report_year-2` (<span class="red">Section 2.1</span>). 

<hr />
<br />

## Resistance to fluoroquinolones and bedaquiline

Fluoroquinolones (a class of second-line anti-TB drug), bedaquiline and linezolid are recommended by WHO as part of treatment regimens for people with drug-resistant TB (`r ref_lnk("5")`).

All those with RR-TB should be tested for pre-extensively drug-resistant TB (pre-XDR-TB), defined as resistance to rifampicin as well as any fluoroquinolone (`r ref_lnk("6")`). Those with pre-XDR-TB should be tested for extensively drug-resistant TB (XDR-TB), defined as resistance to rifampicin, any fluoroquinolone and at least one of either bedaquiline or linezolid. 

There are major gaps in the global cascade of diagnostic testing for pre-XDR-TB and XDR-TB (`r lnk("Fig. 2.2.11")`).


### `r anch("Fig. 2.2.11")`<span class="red">Fig. 2.2.11</span> Global cascade of diagnostic testing^a^ for rifampicin-resistant TB, pre-XDR-TB and XDR-TB, `r report_year - 1`

```{r fig_2.2.11, fig.alt="Bar chart of cascade of TB resistance testing)"}

f2.2.11_plot <- f2.2.11_data |> 
  filter(entity == "Global") |>
  ggplot(aes(x=stage, y=how_many)) +
  geom_bar(stat="identity", fill="blueviolet",width = 0.5) +
  # facet_wrap( ~ entity, ncol = 3, scales="free_y") +
  ylab("Number of people") +

  xlab("") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  theme_gtb() 

output_ggplot(f2.2.11_plot, f2.2.11_data, show_static, pdf_csv_folder, save_csv, save_pdf)
 
```

<div id="fig_2_2_11_global"></div>

<div class="footnote">^a^ Numbers in these bars slightly differ from those shown in <span class="red">Table 2.1.1</span> of <span class="red">Section 2.1</span>. This is because (i) the first bar includes people with MDR/RR-TB who had fluoroquinolone resistance and (ii) the third bar only includes people who were both diagnosed and notified with pre-XDR-TB and XDR-TB in 2024, while <span class="red">Table 2.1.1</span> of <span class="red">Section 2.1</span> includes some notifications of people who were diagnosed with pre-XDR-TB and XDR-TB in previous years.</div>

<hr />
<br />


Globally in `r report_year-1`, the percentage of people diagnosed with RR-TB who were tested for resistance to fluoroquinolones was `r ftb(f2.2.12_txt3$fqdst_pct_2024)`%, a small improvement from `r ftb(f2.2.12_txt3$fqdst_pct_2023)`% in `r report_year-2` and `r ftb(f2.2.12_txt3$fqdst_pct_2022)`% in `r report_year-3` (`r lnk("Fig. 2.2.12")`). Among WHO regions in `r report_year-1`, coverage was highest in the WHO Eastern Mediterranean Region (`r ftb(f2.2.12_txt2$emr)`%) and lowest in the Western Pacific Region (`r ftb(f2.2.12_txt2$wpr)`%).

### `r anch("Fig. 2.2.12")`<span class="red">Fig. 2.2.12</span> Percentage of people diagnosed with rifampicin-resistant TB (RR-TB) who were tested for resistance to fluoroquinolones,^a^ globally and for WHO regions, 2015&#8211;`r report_year-1`
<div class="subhead">`r IDN_2_WPR_note`</div>

```{r fig_2.2.12, fig.alt="Panel plot of RR-TB cases tested for susceptibility to fluoroquinolones by WHO region and globally since 2015"}

f2.2.12_plot <- f2.2.12_data |> 
  
  ggplot(aes(x=year, y=fqdst_pct, ymin=0)) +
  geom_line(size = 1.5, colour = "#277abe") +
  
  scale_x_continuous(name="Year",
                     breaks = seq(2015, report_year-1, by = 2)) +
  scale_y_continuous(name = "Percentage tested") +
  expand_limits(y=c(0,100)) +
  facet_wrap( ~ entity, ncol = 4) +

  theme_gtb() +
  
  # Get rid of annoying x-axis line and ticks
  theme(axis.line.x = ggplot2::element_blank(),
        axis.ticks.x = element_blank())

output_ggplot(f2.2.12_plot, f2.2.12_data, show_static, pdf_csv_folder, save_csv, save_pdf)

```
<div id="fig_2_2_12_global"></div>

<div class="row">
<div class="col-md-4">
<div id="fig_2_2_12_afro"></div>
</div>
<div class="col-md-4">
<div id="fig_2_2_12_amro"></div>
</div>
<div class="col-md-4">
<div id="fig_2_2_12_searo"></div>
</div>
</div>

<div class="row">
<div class="col-md-4">
<div id="fig_2_2_12_euro"></div>
</div>
<div class="col-md-4">
<div id="fig_2_2_12_emro"></div>
</div>
<div class="col-md-4">
<div id="fig_2_2_12_wpro"></div>
</div>
</div>
<div class="footnote">^a^ Testing in years prior to 2019 also included testing for susceptibility to second-line injectables.</div>

<hr />
<br />
There is considerable country variation in the proportion of people diagnosed with RR-TB who were tested for resistance to fluoroquinolones (`r lnk("Fig. 2.2.13")`).

### `r anch("Fig. 2.2.13")`<span class="red">Fig. 2.2.13</span> Percentage of people diagnosed with rifampicin-resistant TB (RR-TB) who were tested for resistance to fluoroquinolones, by country, `r report_year-1`

```{r fig_2.2.13, fig.alt="World map showing percent of MDR/RR-TB cases tested for susceptibility to fluoroquinolones"}

f2.2.13_plot <- f2.2.13_data |> 
  
  whomapper(colours = brewer.pal(4, "Blues"),
         legend_title = "Percentage (%)")

output_ggplot(f2.2.13_plot, f2.2.13_data, show_static = TRUE, pdf_csv_folder, save_csv, save_pdf)

```

<hr />
<br />

In `r report_year-1`, the number and percentage of people with pre-XDR-TB who were tested for resistance to bedaquiline remained low (`r lnk("Fig. 2.2.11")`,`r lnk("Fig. 2.2.14")`).


### `r anch("Fig. 2.2.14")`<span class="red">Fig. 2.2.14</span> Percentage of people diagnosed with pre-XDR-TB^a^ who were tested for resistance to bedaquiline, by country, `r report_year-1`

```{r fig_2.2.14, fig.alt="World map showing percent of pre-XDR-TB cases tested for susceptibility to bedaquiline"}

f2.2.14_plot <- f2.2.14_data |> 
  
  whomapper(colours = brewer.pal(4, "Greens"),
         legend_title = "Percentage (%)")

output_ggplot(f2.2.14_plot, f2.2.14_data, show_static = TRUE, pdf_csv_folder, save_csv, save_pdf)

```
<div class="footnote">^a^ Defined as MDR/RR-TB plus resistance to any fluoroquinolone.</div>

<hr />
<br />

The coverage of testing for resistance to bedaquiline for people with RR-TB was lower still (`r lnk("Fig. 2.2.15")`).

However, a total of `r f2.2.15_txt |> nrow()` countries reached a coverage of at least 80% in `r report_year-1`: `r gsub(" \\(Kingdom of the\\)", "", gsub("(Nether)", "the \\1", knitr::combine_words(f2.2.15_txt$country_in_text_EN, oxford_comma=FALSE)))`.

### `r anch("Fig. 2.2.15")`<span class="red">Fig. 2.2.15</span> Percentage of people diagnosed with rifampicin-resistant TB (RR-TB) who were tested for resistance to bedaquiline, by country, `r report_year-1`

```{r fig_2.2.15, fig.alt="World map showing percent of RR-TB cases tested for susceptibility to bedaquiline"}

f2.2.15_plot <- f2.2.15_data |> 
  
  whomapper(colours = brewer.pal(4, "Purples"),
         legend_title = "Percentage (%)")

output_ggplot(f2.2.15_plot, f2.2.15_data, show_static = TRUE, pdf_csv_folder, save_csv, save_pdf)

```

<hr />
<br />
In `r report_year-1`, the percentage of people with pre-XDR-TB who were tested for resistance to linezolid varied substantially (`r lnk("Fig. 2.2.16")`). However, `r f2.2.16_txt |> nrow()` countries and areas reached a coverage of at least 80% in `r report_year-1`.


### `r anch("Fig. 2.2.16")`<span class="red">Fig. 2.2.16</span> Percentage of people diagnosed with pre-XDR-TB^a^ who were tested for resistance to linezolid, by country, `r report_year-1`

```{r fig_2.2.16, fig.alt="World map showing percent of pre-XDR-TB cases tested for susceptibility to linezolid"}

f2.2.16_plot <- f2.2.16_data |> 
  
  whomapper(colours = brewer.pal(4, "Oranges"),
         legend_title = "Percentage (%)")

output_ggplot(f2.2.16_plot, f2.2.16_data, show_static = TRUE, pdf_csv_folder, save_csv, save_pdf)

```
<div class="footnote">^a^ Defined as MDR/RR-TB plus resistance to any fluoroquinolone.</div>

<hr />
<br />

## HIV status

Of the `r ftb(f2.2.1_data_global$c_newinc/1e6)` million people newly diagnosed with TB globally in `r report_year-1`, `r ftb(f2.2.17_txt$Global_2024)`% had a documented HIV test result, a slight increase from `r ftb(f2.2.17_txt$Global_2023)`% in `r report_year-2` and `r ftb(f2.2.17_txt$Global_2022)`% in `r report_year-3` (`r lnk("Fig. 2.2.17")`). At regional level, the highest percentages were achieved in the WHO African and European regions: `r ftb(f2.2.17_txt$AFR_2024)`% and `r ftb(f2.2.17_txt$EUR_2024)`%, respectively.

### `r anch("Fig. 2.2.17")`<span class="red">Fig. 2.2.17</span> Percentage of people newly diagnosed with TB whose HIV status was documented,^a^ globally and for WHO regions,^b^ 2010&#8211;`r report_year-1`
<div class="subhead">`r IDN_2_WPR_note`</div>

```{r fig_2.2.17, fig.alt="Panel plot of TB cases with known HIV status by WHO region and globally since 2004"}

f2.2.17_plot <- f2.2.17_data |> 
  
  ggplot(aes(x=year, y=hivstatus_pct)) +
  
  geom_line(size = 1.5, colour = "#FA4871") +
  
  scale_x_continuous(name= "Year", breaks = seq(2010, 2022, by=4)) +
  scale_y_continuous(name = "Percentage with documented HIV status") +
  expand_limits(y=c(0,100)) +
  facet_wrap( ~ entity, ncol = 4) +
  
  theme_gtb() +
  
  # Get rid of annoying x-axis line and ticks
  theme(axis.line.x = ggplot2::element_blank(),
        axis.ticks.x = element_blank())

output_ggplot(f2.2.17_plot, f2.2.17_data, show_static, pdf_csv_folder, save_csv, save_pdf)

```
<div id="fig_2_2_17_global"></div>

<div class="row">
<div class="col-md-4">
<div id="fig_2_2_17_afro"></div>
</div>
<div class="col-md-4">
<div id="fig_2_2_17_amro"></div>
</div>
<div class="col-md-4">
<div id="fig_2_2_17_searo"></div>
</div>
</div>

<div class="row">
<div class="col-md-4">
<div id="fig_2_2_17_euro"></div>
</div>
<div class="col-md-4">
<div id="fig_2_2_17_emro"></div>
</div>
<div class="col-md-4">
<div id="fig_2_2_17_wpro"></div>
</div>
</div>

<div class="footnote">^a^ The calculation is for all people diagnosed with TB (new and previously treated cases) in years prior to 2015.<br/>
^b^ Countries were excluded if the number of people with documented HIV status was not reported to WHO.</div>

<hr />
<br />
There was considerable variation at national level (`r lnk("Fig. 2.2.18")`). In `r f2.2.18_txt$over_90` countries and areas, at least 90% of people diagnosed with TB knew their HIV status; this included `r f2.2.18_txt_afr` out of 47 countries (the same as in `r report_year-2`) in the WHO African Region, where the burden of HIV-associated TB is highest. In most countries, the percentage was above 50%. However, in `r f2.2.18_txt_lo` countries in `r report_year-1`, less than half of the people diagnosed with TB knew their HIV status: `r knitr::combine_words(f2.2.18_txt_lo_list$country_in_text_EN, oxford_comma=FALSE)`. This was down from 20 countries in `r report_year-2`. 

### `r anch("Fig. 2.2.18")`<span class="red">Fig. 2.2.18</span> Percentage of people newly diagnosed with TB whose HIV status was documented, by country, `r report_year-1`

```{r fig_2.2.18, fig.alt="World map showing percent of TB cases with known HIV status"}

f2.2.18_plot <- f2.2.18_data |> 
  
  whomapper(colours = brewer.pal(4, "RdPu"),
         legend_title = "Percentage (%)")

output_ggplot(f2.2.18_plot, f2.2.18_data, show_static = TRUE, pdf_csv_folder, save_csv, save_pdf)

```

<br />

Worldwide in `r report_year-1`, a total of `r int_spacer(t2.1.1_txt$newrel_hivpos)` new cases of TB among people living with HIV were notified (<span class="red">Table 2.1.1 of Section 2.1</span>), equivalent to `r ftb(f2.2.17_txt$hivtest_pos_pct)`% of the `r ftb(f2.2.17_txt$hivtest_pos_pct_denominator/1e6)` million people diagnosed with TB who had an HIV test result. Globally, the percentage of people diagnosed with TB who had an HIV-positive test result has been falling for many years, following a peak at `r ftb(f2.2.17_txt2$hivtest_pos_pct)`% in `r f2.2.17_txt2$year`. WHO has compiled data on the number of people diagnosed with TB who had an HIV-positive test result since 2004.


Further country-specific details about diagnostic testing for TB, HIV-associated TB and anti-TB drug resistance are available in the [Global tuberculosis report app](https://www.who.int/teams/global-tuberculosis-programme/data#app) and [country profiles](https://worldhealthorg.shinyapps.io/tb_profiles/).

In 2023, WHO defined 12 benchmarks that can be used to assess and support progress towards universal access to rapid TB diagnostics (`r ref_lnk("7")`). A [WHO dashboard](https://worldhealthorg.shinyapps.io/uad_benchmarks) provides data and visualizations about country progress with respect to the standards.

Data shown on this webpage are as of `r format(as.Date(snapshot_date), format="%d %B %Y")` (see <span class="red">Annex 2</span> of the core report document for more details).

`r anch("refs")`

<hr style="border:1px solid gray20">

**References**

1. WHO consolidated guidelines on tuberculosis. Module 3: Diagnosis. Geneva: World Health Organization; 2025  (https://iris.who.int/handle/10665/381003). License: CC BY-NC-SA 3.0 IGO.
  
2. Consolidated guidance on tuberculosis data generation and use: module 1: tuberculosis surveillance. Geneva: World Health Organization; 2024 (https://iris.who.int/handle/10665/376612). License: CC BY-NC-SA 3.0 IGO.

3. Falzon D, Miller C, Law I, Floyd K, Arinaminpathy N, Zignol M et al. Managing tuberculosis before the onset of symptoms. Lancet Respir Med. 2025;13:14-5. (https://doi.org/10.1016/S2213-2600(24)00372-2).

4. Political declaration of the high-level meeting of the General Assembly on the fight against tuberculosis. New York: United Nations; 2023 (https://www.un.org/pga/77/wp-content/uploads/sites/105/2023/09/TB-Final-Text.pdf).
  
5. WHO consolidated guidelines on tuberculosis. Module 4: treatment and care. Geneva: World Health Organization; 2025 (https://iris.who.int/handle/10665/380799). License: CC BY-NC-SA 3.0 IGO.

6. Meeting report of the WHO expert consultation on the definition of extensively drug-resistant tuberculosis, 27-29 October 2020. Geneva: World Health Organization; 2021 (https://iris.who.int/handle/10665/338776). License: CC BY-NC-SA 3.0 IGO.

7. WHO standard: universal access to rapid tuberculosis diagnostics. Geneva: World Health Organization; 2023 (https://iris.who.int/handle/10665/366854). License: CC BY-NC-SA 3.0 IGO.
  
<hr style="border:1px solid gray20">

**General disclaimers**
<br>
The designations employed and the presentation of the material in this publication do not imply the expression of any opinion whatsoever on the part of WHO concerning the legal status of any country, territory, city or area or of its authorities, or concerning the delimitation of its frontiers or boundaries. Dotted and dashed lines on maps represent approximate border lines for which there may not yet be full agreement.



```{r js_functions}
# Insert javascript file containing common Kendo number formatting functions ----
cat(writeLines(readLines(here("report/resources/gtbr_js.htm"))))
```

<script type="text/javascript">
/* JSON data objects for the figures */

var fig_2_2_1_data = `r f2.2.1_data |> toJSON("rows")`;

var fig_2_2_2_data = `r f2.2.2_data  |> toJSON("rows")` ;  

var fig_2_2_4_data = `r f2.2.4_data  |> toJSON("rows")` ;  

var fig_2_2_6_data = `r f2.2.6_data |> select(year,entity,value=bacconf_pct) |> toJSON("rows")`   ;  

var fig_2_2_8_data = `r f2.2.8_data  |> toJSON("rows")` ;  

var fig_2_2_9_data = `r f2.2.9_data  |> select(year, entity, value=dst_pcnt) |> toJSON("rows")`   ;  

var fig_2_2_11_data = `r f2.2.11_data |> toJSON("rows")`;

var fig_2_2_12_data = `r f2.2.12_data  |> select(year, entity, value=fqdst_pct) |> toJSON("rows")`   ;  

var fig_2_2_17_data = `r f2.2.17_data  |> select(year, entity, value=hivstatus_pct) |> toJSON("rows")`   ;  


</script>

```{js, echo=FALSE}


function createFig_2_2_1(fig_ID, data, filter, color) {
  		// Filter the dataset on the country variable
		dataJSON = data.filter( element => element.entity == filter);
  
		$(fig_ID).kendoChart({
            dataSource: {
                data: dataJSON
            },

            legend: {
              // hide the legend
              visible: false
            },
            seriesDefaults: {
                type: "column",
                gap: 0.2,
                tooltip: {
                    visible: true,
                    template: "#= category #: #= num_spacer(value)#"
                }
            },
            series: [{
                name: "Number of people",
                field: "how_many",
                color: color
                }],
            valueAxis: {
                labels: {
                    template: "#= kendo.format('{0}',value/1000000) #"
                },
                title: {
                    text: "Number of people (millions)"
                },
                line: {
                    visible: false
                }
            },
            categoryAxis: {
                field: "stage",
                labels: {
                    rotation: "auto"
                },
                majorGridLines: {
                    visible: false
                }
            }
        });
}


function createFig_2_2_2(fig_ID, data, filter, x_axis_title = True, y_axis_title = True, height) {
  
  		// Filter the dataset on the country variable
		dataJSON = data.filter( element => element.entity == filter);
  
		$(fig_ID).kendoChart({
			dataSource: dataJSON,
			chartArea: {
				height: height
			},	
      title: {
				text: filter,
				color: "black",
				font: "bold 14px  Arial,Helvetica,sans-serif",
        align: "center"
			},	
			legend: {
				position: "bottom"
			},
			seriesDefaults: {
				type: "line"
			},
			series: [{
				field: "wrd_pcnt",
				color: "#8A2BE2", 
        markers: {
          size: 3
        },
        tooltip: {
				visible: true,
				format: "{0:0.00}",
				template: "#= category #: #= tb_format_pct(value) #%",
			}
			}],
			valueAxis: {
				labels: {
					format: "{0}"
				},
				title: {
					text: "Percentage",
					visible: y_axis_title,
          font: "14px Arial,Helvetica,sans-serif"
				},
				line: {
					visible: false
				},
        max: 104,
        min: 0
			},
			categoryAxis: {
				field: "year",
        labels: {
					rotation: 0,
          step: 2
          },
				majorGridLines: {
					visible: false
				},
				title: {
					text: "Year",
					visible: x_axis_title
				}
			}

		});
}

function createFig_2_2_6(fig_ID, data, filter, x_axis_title = True, y_axis_title = True, color, y_axis_title_text) {
  
  		// Filter the dataset on the country variable
		dataJSON = data.filter( element => element.entity == filter);
  
		$(fig_ID).kendoChart({
			dataSource: dataJSON,
			chartArea: {
				height: 250
			},	
      title: {
				text: filter,
				color: "black",
				font: "bold 14px  Arial,Helvetica,sans-serif",
        align: "center"
			},	
			legend: {
				position: "bottom"
			},
			seriesDefaults: {
				type: "line"
			},
			series: [{
				field: "value",
				color: color, 
        markers: {
          size: 3
        },
        tooltip: {
				visible: true,
				format: "{0:0.00}",
				template: "#= category #: #= tb_format_pct(value) #%",
			}
			}],
			valueAxis: {
				labels: {
					format: "{0}"
				},
				title: {
					text: y_axis_title_text,
					visible: y_axis_title,
          font: "14px Arial,Helvetica,sans-serif"
				},
				line: {
					visible: false
				},
        max: 102,
        min: 0
			},
			categoryAxis: {
				field: "year",
        labels: {
					rotation: 0,
          step: 2
          },
				majorGridLines: {
					visible: false
				},
				title: {
					text: "Year",
					visible: x_axis_title
				}
			}

		});
}


function createFig_2_2_8(fig_ID, data, filter, x_axis_title = True, y_axis_title = True) {
  
  		// Filter the dataset on the country variable
		dataJSON = data.filter( element => element.country == filter);
  
		$(fig_ID).kendoChart({
			dataSource: dataJSON,
			chartArea: {
				height: 250
			},	
      title: {
				text: filter,
				color: "black",
				font: "bold 14px  Arial,Helvetica,sans-serif",
        align: "center"
			},	
			legend: {
				position: "bottom"
			},
			seriesDefaults: {
				type: "line"
			},
			series: [{
				field: "bacconf_pct",
				color: "#2e8b57", 
        markers: {
          size: 3
        },
        tooltip: {
				visible: true,
				format: "{0:0.00}",
				template: "#= category #: #= value.toPrecision(2) #%",
			}
			}],
			valueAxis: {
				labels: {
					format: "{0}"
				},
				title: {
					text: "Percentage\nbacterioloically confirmed",
					visible: y_axis_title,
          font: "14px Arial,Helvetica,sans-serif"
				},
				line: {
					visible: false
				},
        max: 100,
        min: 0
			},
			categoryAxis: {
				field: "year",
        labels: {
					rotation: 0,
          step: 3
          },
				majorGridLines: {
					visible: false
				},
				title: {
					text: "Year",
					visible: x_axis_title
				}
			}

		});
}


function createFig_2_2_11(fig_ID, data, filter, color) {
  		// Filter the dataset on the country variable
		dataJSON = data.filter( element => element.entity == filter);
  
		$(fig_ID).kendoChart({
            dataSource: {
                data: dataJSON
            },

            legend: {
              // hide the legend
              visible: false
            },
            seriesDefaults: {
                type: "column",
                gap: 0.2,
                tooltip: {
                    visible: true,
                    template: "#= category #: #= num_spacer(value)#"
                }
            },
            series: [{
                name: "Number of people",
                field: "how_many",
                color: color
                }],
            valueAxis: {
                labels: {
                    template: "#= num_spacer(value) #"
                },
                title: {
                    text: "Number of people"
                },
                line: {
                    visible: false
                }
            },
            categoryAxis: {
                field: "stage",
                labels: {
                    rotation: "auto"
                },
                majorGridLines: {
                    visible: false
                }
            }
        });
}




```

```{js, echo=FALSE}


/* Create the figures after the document has been loaded */

$(document).ready(function () {

                 createFig_2_2_1("#fig_2_2_1_global",fig_2_2_1_data,"Global","#2E8B57"); 
                 createFig_2_2_11("#fig_2_2_11_global",fig_2_2_11_data,"Global","#8A2BE2");

                 createFig_2_2_2("#fig_2_2_2",fig_2_2_2_data,"Global",true,true,500);
                 createFig_2_2_2("#fig_2_2_2_euro",fig_2_2_2_data,"European Region",true,true,250);
                 createFig_2_2_2("#fig_2_2_2_afro",fig_2_2_2_data,"African Region",true,true,250);
                 createFig_2_2_2("#fig_2_2_2_emro",fig_2_2_2_data,"Eastern Mediterranean Region",true,true,250);
                 createFig_2_2_2("#fig_2_2_2_amro",fig_2_2_2_data,"Region of the Americas",true,true,250);
                 createFig_2_2_2("#fig_2_2_2_wpro",fig_2_2_2_data,"Western Pacific Region",true,true,250);
                 createFig_2_2_2("#fig_2_2_2_searo",fig_2_2_2_data,"South-East Asia Region",true,true,250);

                 createFig_2_2_2("#fig_2_2_4_AGO",fig_2_2_4_data,"Angola",true,true,250);
                 createFig_2_2_2("#fig_2_2_4_COG",fig_2_2_4_data,"Congo",true,true,250);
                 createFig_2_2_2("#fig_2_2_4_IND",fig_2_2_4_data,"India",true,true,250);
                 createFig_2_2_2("#fig_2_2_4_MNG",fig_2_2_4_data,"Mongolia",true,true,250);
                 createFig_2_2_2("#fig_2_2_4_PAK",fig_2_2_4_data,"Pakistan",true,true,250);
                 createFig_2_2_2("#fig_2_2_4_THA",fig_2_2_4_data,"Thailand",true,true,250);
                 createFig_2_2_2("#fig_2_2_4_BGD",fig_2_2_4_data,"Bangladesh",true,true,250);
                 createFig_2_2_2("#fig_2_2_4_PRK",fig_2_2_4_data,"Democratic People's\nRepublic of Korea",true,true,250);
                 createFig_2_2_2("#fig_2_2_4_IDN",fig_2_2_4_data,"Indonesia",true,true,250);
                 createFig_2_2_2("#fig_2_2_4_MOZ",fig_2_2_4_data,"Mozambique",true,true,250);
                 createFig_2_2_2("#fig_2_2_4_PNG",fig_2_2_4_data,"Papua New Guinea",true,true,250);
                 createFig_2_2_2("#fig_2_2_4_UGA",fig_2_2_4_data,"Uganda",true,true,250);
                 createFig_2_2_2("#fig_2_2_4_BRA",fig_2_2_4_data,"Brazil",true,true,250);
                 createFig_2_2_2("#fig_2_2_4_COD",fig_2_2_4_data,"Democratic Republic\nof the Congo",true,true,250);
                 createFig_2_2_2("#fig_2_2_4_KEN",fig_2_2_4_data,"Kenya",true,true,250);
                 createFig_2_2_2("#fig_2_2_4_MMR",fig_2_2_4_data,"Myanmar",true,true,250);
                 createFig_2_2_2("#fig_2_2_4_PHL",fig_2_2_4_data,"Philippines",true,true,250);
                 createFig_2_2_2("#fig_2_2_4_TZA",fig_2_2_4_data,"United Republic of Tanzania",true,true,250);
                 createFig_2_2_2("#fig_2_2_4_CAF",fig_2_2_4_data,"Central African Republic",true,true,250);
                 createFig_2_2_2("#fig_2_2_4_ETH",fig_2_2_4_data,"Ethiopia",true,true,250);
                 createFig_2_2_2("#fig_2_2_4_LSO",fig_2_2_4_data,"Lesotho",true,true,250);
                 createFig_2_2_2("#fig_2_2_4_NAM",fig_2_2_4_data,"Namibia",true,true,250);
                 createFig_2_2_2("#fig_2_2_4_SLE",fig_2_2_4_data,"Sierra Leone",true,true,250);
                 createFig_2_2_2("#fig_2_2_4_VNM",fig_2_2_4_data,"Viet Nam",true,true,250);
                 createFig_2_2_2("#fig_2_2_4_CHN",fig_2_2_4_data,"China",true,true,250);
                 createFig_2_2_2("#fig_2_2_4_GAB",fig_2_2_4_data,"Gabon",true,true,250);
                 createFig_2_2_2("#fig_2_2_4_LBR",fig_2_2_4_data,"Liberia",true,true,250);
                 createFig_2_2_2("#fig_2_2_4_NGA",fig_2_2_4_data,"Nigeria",true,true,250);
                 createFig_2_2_2("#fig_2_2_4_ZAF",fig_2_2_4_data,"South Africa",true,true,250);
                 createFig_2_2_2("#fig_2_2_4_ZMB",fig_2_2_4_data,"Zambia",true,true,250);

                 createFig_2_2_6("#fig_2_2_6_global",fig_2_2_6_data,"Global",true,true,"#2e8b57","Percentage\nbacterioloically confirmed");
                 createFig_2_2_6("#fig_2_2_6_euro",fig_2_2_6_data,"European Region",true,true,"#2e8b57","Percentage\nbacterioloically confirmed");
                 createFig_2_2_6("#fig_2_2_6_afro",fig_2_2_6_data,"African Region",true,true,"#2e8b57","Percentage\nbacterioloically confirmed");
                  createFig_2_2_6("#fig_2_2_6_emro",fig_2_2_6_data,"Eastern Mediterranean Region",true,true,"#2e8b57","Percentage\nbacterioloically confirmed");
                  createFig_2_2_6("#fig_2_2_6_amro",fig_2_2_6_data,"Region of the Americas",true,true,"#2e8b57","Percentage\nbacterioloically confirmed");
                  createFig_2_2_6("#fig_2_2_6_wpro",fig_2_2_6_data,"Western Pacific Region",true,true,"#2e8b57","Percentage\nbacterioloically confirmed");
                  createFig_2_2_6("#fig_2_2_6_searo",fig_2_2_6_data,"South-East Asia Region",true,true,"#2e8b57","Percentage\nbacterioloically confirmed");

                  createFig_2_2_6("#fig_2_2_9_global",fig_2_2_9_data,"Global",true,true,"#e52000","Percentage tested");
                 createFig_2_2_6("#fig_2_2_9_euro",fig_2_2_9_data,"European Region",true,true,"#e52000","Percentage tested");
                 createFig_2_2_6("#fig_2_2_9_afro",fig_2_2_9_data,"African Region",true,true,"#e52000","Percentage tested");
                  createFig_2_2_6("#fig_2_2_9_emro",fig_2_2_9_data,"Eastern Mediterranean Region",true,true,"#e52000","Percentage tested");
                  createFig_2_2_6("#fig_2_2_9_amro",fig_2_2_9_data,"Region of the Americas",true,true,"#e52000","Percentage tested");
                  createFig_2_2_6("#fig_2_2_9_wpro",fig_2_2_9_data,"Western Pacific Region",true,true,"#e52000","Percentage tested");
                  createFig_2_2_6("#fig_2_2_9_searo",fig_2_2_9_data,"South-East Asia Region",true,true,"#e52000","Percentage tested");
                  
                  createFig_2_2_6("#fig_2_2_12_global",fig_2_2_12_data,"Global",true,true,"#277abe","Percentage tested");
                 createFig_2_2_6("#fig_2_2_12_euro",fig_2_2_12_data,"European Region",true,true,"#277abe","Percentage tested");
                 createFig_2_2_6("#fig_2_2_12_afro",fig_2_2_12_data,"African Region",true,true,"#277abe","Percentage tested");
                  createFig_2_2_6("#fig_2_2_12_emro",fig_2_2_12_data,"Eastern Mediterranean Region",true,true,"#277abe","Percentage tested");
                  createFig_2_2_6("#fig_2_2_12_amro",fig_2_2_12_data,"Region of the Americas",true,true,"#277abe","Percentage tested");
                  createFig_2_2_6("#fig_2_2_12_wpro",fig_2_2_12_data,"Western Pacific Region",true,true,"#277abe","Percentage tested");
                  createFig_2_2_6("#fig_2_2_12_searo",fig_2_2_12_data,"South-East Asia Region",true,true,"#277abe","Percentage tested");
                  
                 createFig_2_2_8("#fig_2_2_8_AGO",fig_2_2_8_data,"Angola",true,true);
                 createFig_2_2_8("#fig_2_2_8_COG",fig_2_2_8_data,"Congo",true,true);
                 createFig_2_2_8("#fig_2_2_8_IND",fig_2_2_8_data,"India",true,true);
                 createFig_2_2_8("#fig_2_2_8_MNG",fig_2_2_8_data,"Mongolia",true,true);
                 createFig_2_2_8("#fig_2_2_8_PAK",fig_2_2_8_data,"Pakistan",true,true);
                 createFig_2_2_8("#fig_2_2_8_THA",fig_2_2_8_data,"Thailand",true,true);
                 createFig_2_2_8("#fig_2_2_8_BGD",fig_2_2_8_data,"Bangladesh",true,true);
                 createFig_2_2_8("#fig_2_2_8_PRK",fig_2_2_8_data,"Democratic People's\nRepublic of Korea",true,true);
                 createFig_2_2_8("#fig_2_2_8_IDN",fig_2_2_8_data,"Indonesia",true,true);
                 createFig_2_2_8("#fig_2_2_8_MOZ",fig_2_2_8_data,"Mozambique",true,true);
                 createFig_2_2_8("#fig_2_2_8_PNG",fig_2_2_8_data,"Papua New Guinea",true,true);
                 createFig_2_2_8("#fig_2_2_8_UGA",fig_2_2_8_data,"Uganda",true,true);
                 createFig_2_2_8("#fig_2_2_8_BRA",fig_2_2_8_data,"Brazil",true,true);
                 createFig_2_2_8("#fig_2_2_8_COD",fig_2_2_8_data,"Democratic Republic\nof the Congo",true,true);
                 createFig_2_2_8("#fig_2_2_8_KEN",fig_2_2_8_data,"Kenya",true,true);
                 createFig_2_2_8("#fig_2_2_8_MMR",fig_2_2_8_data,"Myanmar",true,true);
                 createFig_2_2_8("#fig_2_2_8_PHL",fig_2_2_8_data,"Philippines",true,true);
                 createFig_2_2_8("#fig_2_2_8_TZA",fig_2_2_8_data,"United Republic of Tanzania",true,true);
                 createFig_2_2_8("#fig_2_2_8_CAF",fig_2_2_8_data,"Central African Republic",true,true);
                 createFig_2_2_8("#fig_2_2_8_ETH",fig_2_2_8_data,"Ethiopia",true,true);
                 createFig_2_2_8("#fig_2_2_8_LSO",fig_2_2_8_data,"Lesotho",true,true);
                 createFig_2_2_8("#fig_2_2_8_NAM",fig_2_2_8_data,"Namibia",true,true);
                 createFig_2_2_8("#fig_2_2_8_SLE",fig_2_2_8_data,"Sierra Leone",true,true);
                 createFig_2_2_8("#fig_2_2_8_VNM",fig_2_2_8_data,"Viet Nam",true,true);
                 createFig_2_2_8("#fig_2_2_8_CHN",fig_2_2_8_data,"China",true,true);
                 createFig_2_2_8("#fig_2_2_8_GAB",fig_2_2_8_data,"Gabon",true,true);
                 createFig_2_2_8("#fig_2_2_8_LBR",fig_2_2_8_data,"Liberia",true,true);
                 createFig_2_2_8("#fig_2_2_8_NGA",fig_2_2_8_data,"Nigeria",true,true);
                 createFig_2_2_8("#fig_2_2_8_ZAF",fig_2_2_8_data,"South Africa",true,true);
                 createFig_2_2_8("#fig_2_2_8_ZMB",fig_2_2_8_data,"Zambia",true,true);

                  createFig_2_2_6("#fig_2_2_17_global",fig_2_2_17_data,"Global",true,true,"#FA4871","Percentage\nwith documented HIV status");
                 createFig_2_2_6("#fig_2_2_17_euro",fig_2_2_17_data,"European Region",true,true,"#FA4871","Percentage\nwith documented HIV status");
                 createFig_2_2_6("#fig_2_2_17_afro",fig_2_2_17_data,"African Region",true,true,"#FA4871","Percentage\nwith documented HIV status");
                  createFig_2_2_6("#fig_2_2_17_emro",fig_2_2_17_data,"Eastern Mediterranean Region",true,true,"#FA4871","Percentage\nwith documented HIV status");
                  createFig_2_2_6("#fig_2_2_17_amro",fig_2_2_17_data,"Region of the Americas",true,true,"#FA4871","Percentage\nwith documented HIV status");
                  createFig_2_2_6("#fig_2_2_17_wpro",fig_2_2_17_data,"Western Pacific Region",true,true,"#FA4871","Percentage\nwith documented HIV status");
                  createFig_2_2_6("#fig_2_2_17_searo",fig_2_2_17_data,"South-East Asia Region",true,true,"#FA4871","Percentage\nwith documented HIV status");
                  


});  
  
```
